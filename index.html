
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      
      <link rel="icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.4.6">
    
    
      
        <title>Food Geek Documentation</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.35e1ed30.min.css">
      
        
        <link rel="stylesheet" href="assets/stylesheets/palette.356b1318.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
      
        <meta  property="og:type"  content="website" >
      
        <meta  property="og:title"  content="Home" >
      
        <meta  property="og:description"  content="None" >
      
        <meta  property="og:image"  content="./assets/images/social/index.png" >
      
        <meta  property="og:image:type"  content="image/png" >
      
        <meta  property="og:image:width"  content="1200" >
      
        <meta  property="og:image:height"  content="630" >
      
        <meta  property="og:url"  content="None" >
      
        <meta  name="twitter:card"  content="summary_large_image" >
      
        <meta  name="twitter:title"  content="Home" >
      
        <meta  name="twitter:description"  content="None" >
      
        <meta  name="twitter:image"  content="./assets/images/social/index.png" >
      
    
    
   <link href="assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
        html.glightbox-open { overflow: initial; height: 100%; }
        .gslide-title { margin-top: 0px; user-select: text; }
        .gslide-desc { color: #666; user-select: text; }
        .gslide-image img { background: white; }
        
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}
            </style> <script src="assets/javascripts/glightbox.min.js"></script></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="lime">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#how-i-created-a-food-segmentation-web-app-food-geek" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="." title="Food Geek Documentation" class="md-header__button md-logo" aria-label="Food Geek Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Food Geek Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Home
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="lime"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="purple"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
</form>
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/JohnPPinto/food-geek-food-image-segmentation" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    JohnPPinto/food-geek-food-image-segmentation
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="." title="Food Geek Documentation" class="md-nav__button md-logo" aria-label="Food Geek Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Food Geek Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/JohnPPinto/food-geek-food-image-segmentation" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    JohnPPinto/food-geek-food-image-segmentation
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Home
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="." class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#the-challenge" class="md-nav__link">
    The Challenge
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#data-pipeline" class="md-nav__link">
    Data Pipeline
  </a>
  
    <nav class="md-nav" aria-label="Data Pipeline">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gathering-the-training-data" class="md-nav__link">
    Gathering the Training Data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#preprocessing-the-data" class="md-nav__link">
    Preprocessing the Data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-and-processing-data-annotations" class="md-nav__link">
    Creating and Processing Data Annotations
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#model-pipeline" class="md-nav__link">
    Model Pipeline
  </a>
  
    <nav class="md-nav" aria-label="Model Pipeline">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#model-training" class="md-nav__link">
    Model Training
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#model-evaluation-and-export" class="md-nav__link">
    Model Evaluation and Export
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deployment-pipeline" class="md-nav__link">
    Deployment Pipeline
  </a>
  
    <nav class="md-nav" aria-label="Deployment Pipeline">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adapting-to-onnx" class="md-nav__link">
    Adapting to ONNX
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#building-api-and-web-app" class="md-nav__link">
    Building API and Web App
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#future-prospect" class="md-nav__link">
    Future Prospect
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#final-words" class="md-nav__link">
    Final Words
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<p>June 1, 2023</p>
<h1 id="how-i-created-a-food-segmentation-web-app-food-geek"><strong>How I Created a Food Segmentation Web App - Food Geek</strong></h1>
<p>This project is a demonstration of my ability to work in the field of Deep Learning, showcase my skills to learn quickly and develop and deploy end-to-end Artificial Intelligence technologies. Currently, this project is still in work in progress phase, the project has completed the first stage of deployment and will be moving toward the continuous training (CT) stage, where I will be going back to the data pipeline and iterating improvements to all of the pipelines.</p>
<h2 id="the-challenge"><strong>The Challenge</strong></h2>
<p>This project creates a web application for different types of food, the web app is capable of understanding the foods by using a neural network architecture. Once the web app identifies the food with the help of the neural network it will display all the nutrients present in that food.</p>
<p>This is a simple implementation of a classification problem, where deep learning is really good at solving it, but there's a catch to this, assume a user eats only one food and uses the web app then the image classification problem will be a straightforward method. But this is not the case for everyone, some might click a photo containing 2 or more foods on a plate or a wide-view photo of the dining table or a buffet with multiple different foods.</p>
<p>When images have a lot of information, only performing image classification is not the best option, to clearly identify all the objects in this case food, object detection, or segmentation works the best. Now, selecting either one will do the work but object detection itself has a flaw here, many times foods can get messy, and drawing a box that has a strict shape can make the visualization bad. So the next best one is instance segmentation where polygon shapes can detect all the objects even though it's a messy plate.</p>
<h2 id="data-pipeline"><strong>Data Pipeline</strong></h2>
<p>The first and foremost steps for building any deep learning project start with the data pipeline, from getting the data to processing it all falls into this space. This stage is the most critical of all in every project, most of the time improving your data can improve the result far better than any other method.</p>
<h3 id="gathering-the-training-data"><strong>Gathering the Training Data</strong></h3>
<p>In deep learning projects, the hardest part is getting a large quantity and a good quality dataset. I imagine this is why most of the papers and research are done on well-known datasets like ImageNet, COCO, etc.</p>
<p>So to start with I will also be using a public dataset, the most popular dataset in the food category is the "<a href="https://data.vision.ee.ethz.ch/cvl/datasets_extra/food-101/">Food - 101 Data Set</a>". This dataset is provided by "<a href="https://ethz.ch/en.html">ETH Zürich</a>", a public research university in Zürich, Switzerland. They have also produced multiple papers and large datasets for deep learning.</p>
<p>This dataset contains 101,000 images for 101 different foods. All of these food images were been reviewed manually and each food class was segregated into a train set containing 750 images and a test set containing 250 images. They have on purpose not cleaned the training images which contain some noise, mostly in the form of color intensity and wrong labels. All the images are also rescaled to have a maximum side length of 512 pixels.</p>
<p>You can find the complete code over <a href="https://github.com/JohnPPinto/food-geek-food-image-segmentation/blob/main/notebooks/01_downlaod_dataset.ipynb">here</a>.</p>
<h3 id="preprocessing-the-data"><strong>Preprocessing the Data</strong></h3>
<p>In this stage, I will be keeping it simple. Neural networks need data for learning patterns and so do their needs for validating their performance. This can be achieved by separating the dataset into two different sets, one called the training set containing a good amount of the images and the next one is a validation set or a testing set, or both of them. </p>
<p>The dataset is already split into a train and test in a ratio of 75:25, this means that 75 percent of the data is for training and the rest 25 percent is for testing. Making no changes to this, I will be using the same split.</p>
<p>The basic workflow for any machine learning project, in general, is to start small, this means that use a small part of the dataset and experiment with that, once you feel that data needs to be increased then you start adding more data to the neural network. This way you can scale the architecture and improve the performance.</p>
<p>Starting small for this project, I will be taking 5 classes on food: Chicken Curry, Chocolate Cake, Hamburger, Pizza, and ramen. Now, why did I select this food among the 101 different foods, this is because these foods are common and some are even in the fast food category. Along with the few classes, I have also decreased the dataset by 10 percent of the data for each class, which means 75 training images and 25 testing images.</p>
<p>You can find the complete code over <a href="https://github.com/JohnPPinto/food-geek-food-image-segmentation/blob/main/notebooks/02_data_preprocessing_eda.ipynb">here</a>.</p>
<h3 id="creating-and-processing-data-annotations"><strong>Creating and Processing Data Annotations</strong></h3>
<p>Now, that we have the images we will also be needing the annotations for all the images. Annotation is a file containing the metadata for the images, this metadata might contain filenames, class, box shape in a specific format, polygon shape in a specific format, and many more details.</p>
<p>Creating annotation is a critical stage where major mistakes are not tolerable, these sorts of data have a major impact on the neural network's result. To create an annotation for my food images, I will be using the tool called <a href="https://www.cvat.ai/">CVAT</a>, it's one of the best open-source tools for annotating any data in computer vision tasks. After, annotating my images I exported them in the format of Segmentation Mask annotation. This format outputs the selected segment of the object for the image in a new image containing 1 channel, a grayscale image that has a white color (1 Values) for the segmented object and the rest of the image is in black color(0 Values pixel).</p>
<figure>
<p><a class="glightbox" href="images/mask_img.png" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="Mask Image" src="images/mask_img.png" width="450" /></a>
  </p>
<figcaption>A Mask Image Containing Two Objects</figcaption>
</figure>
<p>Now that I have created the mask for all the images, the trickiest part was to convert the mask image into a format that the neural network will look for and extract those annotations in its standard format. Using YOLO as my neural network, I will need to convert the mask into a text file that will contain the polygon location.</p>
<p>I like to create a function that can convert the mask image into a YOLO text file. This function takes the help of the OpenCV library which has a lot of functions to manipulate images and video files. </p>
<ul>
<li>
<p><strong>Line: 2-4:</strong> First, I read the image file as a grayscale image. Then apply a <code>cv2.threshold</code> of 1, where the maximum value is 255 for all the pixels in the image, and capture the height and width of the image.</p>
</li>
<li>
<p><strong>Line: 6:</strong> Now that the image is read and we have some metadata, we will get the polygon shape using the <code>cv2.findContours</code> function, this function uses <code>`CHAIN_APPROX_SIMPLE</code> to get the minimum coordinates but important ones which helps in the compute size and time.</p>
</li>
<li>
<p><strong>Line: 8-16:</strong> Now that we have the coordinates for all the points of the polygon, we need to normalize the values between 0 and 1. Contours provide a tuple within which all the point's x and y coordinates are present in a list, I then divide them with height and width and append them in the list in the format of [x1, y1, x2, y2, ...]</p>
</li>
<li>
<p><strong>Line: 18-31:</strong> Getting the index of the class from the file path directory and creating a file where I add the values in the Yolo format, starting with the class index and then adding all the normalized coordinates in that one line, in Yolo format one object can have only one line.</p>
</li>
</ul>
<p><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-0-10">10</a></span>
<span class="normal"><a href="#__codelineno-0-11">11</a></span>
<span class="normal"><a href="#__codelineno-0-12">12</a></span>
<span class="normal"><a href="#__codelineno-0-13">13</a></span>
<span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">def</span> <span class="nf">mask_to_yolo</span><span class="p">(</span><span class="n">src_filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst_filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">class_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>    <span class="c1"># Reading the mask annotation file</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">src_filepath</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_GRAYSCALE</span><span class="p">)</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>    <span class="n">_</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">threshold</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">THRESH_BINARY</span><span class="p">)</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>    <span class="n">H</span><span class="p">,</span> <span class="n">W</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>    <span class="c1"># Getting the contours of the mask image</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>    <span class="n">contours</span><span class="p">,</span> <span class="n">hierarchy</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findContours</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">RETR_EXTERNAL</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CHAIN_APPROX_SIMPLE</span><span class="p">)</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>    <span class="c1"># Normalizing the contours</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>    <span class="n">polygons</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>    <span class="k">for</span> <span class="n">cnt</span> <span class="ow">in</span> <span class="n">contours</span><span class="p">:</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>        <span class="k">if</span> <span class="n">cv2</span><span class="o">.</span><span class="n">contourArea</span><span class="p">(</span><span class="n">cnt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">:</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>            <span class="n">polygon</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>            <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">cnt</span><span class="p">:</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>                <span class="n">polygon</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">W</span><span class="p">)</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>                <span class="n">polygon</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span> <span class="o">/</span> <span class="n">H</span><span class="p">)</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>            <span class="n">polygons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">polygon</span><span class="p">)</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>    <span class="c1"># Getting the class of the annotation</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>    <span class="n">class_idx</span> <span class="o">=</span> <span class="n">class_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">src_filepath</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>    <span class="c1"># Creating a file in yolo format and writing all the annotations</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dst_filepath</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>        <span class="k">for</span> <span class="n">polygon</span> <span class="ow">in</span> <span class="n">polygons</span><span class="p">:</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">polygon</span><span class="p">):</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">class_idx</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1"> &#39;</span><span class="p">)</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>                <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">polygon</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1"> &#39;</span><span class="p">)</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>    <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>    <span class="k">if</span> <span class="n">verbose</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[INFO] Mask file is been converted into Yolo format: &quot;</span><span class="si">{</span><span class="n">dst_filepath</span><span class="si">}</span><span class="s1">&quot;.&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
Now that we have the function to create an annotation file, it's time to pass it to all the mask files and create a text file for that mask polygon. I get the full path for the mask file and create a path with the same name changing the extension to .txt for a text file.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-1-10">10</a></span>
<span class="normal"><a href="#__codelineno-1-11">11</a></span>
<span class="normal"><a href="#__codelineno-1-12">12</a></span>
<span class="normal"><a href="#__codelineno-1-13">13</a></span>
<span class="normal"><a href="#__codelineno-1-14">14</a></span>
<span class="normal"><a href="#__codelineno-1-15">15</a></span>
<span class="normal"><a href="#__codelineno-1-16">16</a></span>
<span class="normal"><a href="#__codelineno-1-17">17</a></span>
<span class="normal"><a href="#__codelineno-1-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="k">def</span> <span class="nf">create_yolo_labels</span><span class="p">(</span><span class="n">src_root_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dst_root_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">class_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>    <span class="c1"># Getting all the mask files path</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a>    <span class="k">for</span> <span class="n">classes</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src_root_dir</span><span class="p">)):</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a>        <span class="n">class_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src_root_dir</span><span class="p">,</span> <span class="n">classes</span><span class="p">)</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="hll">        <span class="n">filepath</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">class_path</span><span class="p">,</span> <span class="n">i</span> <span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">class_path</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;.ipynb_checkpoints&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">i</span><span class="p">]</span>
</span><a id="__codelineno-1-6" name="__codelineno-1-6"></a>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a>        <span class="c1"># Creating the destination directory</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a>        <span class="n">dst_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst_root_dir</span><span class="p">,</span> <span class="n">classes</span><span class="p">)</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dst_dir</span><span class="p">):</span>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a>            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dst_dir</span><span class="p">)</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a>        <span class="c1"># Creating Yolo format annotation file for every mask file</span>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="hll">        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">classes</span><span class="p">):</span>
</span><a id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="hll">            <span class="n">mask_to_yolo</span><span class="p">(</span><span class="n">src_filepath</span><span class="o">=</span><span class="n">file</span><span class="p">,</span>
</span><a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="hll">                         <span class="n">dst_filepath</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst_dir</span><span class="p">,</span> <span class="n">file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.png&#39;</span><span class="p">,</span> <span class="s1">&#39;.txt&#39;</span><span class="p">)),</span>
</span><a id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="hll">                         <span class="n">class_list</span><span class="o">=</span><span class="n">class_list</span><span class="p">,</span>
</span><a id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="hll">                         <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
</span><a id="__codelineno-1-18" name="__codelineno-1-18"></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[INFO] All the mask files are converted into Yolo format.&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>Now, it's time to test the converted annotation and the best way is to visualize and check it on different images and the function plot_yolo_segment does that for us.</p>
<ul>
<li>
<p><strong>Lines: 3-24:</strong> Here I read the image file and the text file. Then I extract the yolo annotation from the file and add it to a list called norm_annot. After that using the odd and even method, I denormalize the annotation for the image and append it again to another list called denorm_annot. Finally, create a contour like format data for the annotation. </p>
</li>
<li>
<p><strong>Lines: 27-52:</strong> Now that I have the contours, I can use <code>cv2.boundingRect</code> to get the box coordinates(top left x, top left y, width, height) and draw the contours on the image using <code>cv2.drawContours</code> with some opacity using <code>cv2.addWeighted</code>. After that draw the rectangle box using <code>cv2.rectangle</code> and add the class text for identification using <code>cv2.putText</code>. Finally, plot the original and annotated image for comparison. </p>
</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-2-10">10</a></span>
<span class="normal"><a href="#__codelineno-2-11">11</a></span>
<span class="normal"><a href="#__codelineno-2-12">12</a></span>
<span class="normal"><a href="#__codelineno-2-13">13</a></span>
<span class="normal"><a href="#__codelineno-2-14">14</a></span>
<span class="normal"><a href="#__codelineno-2-15">15</a></span>
<span class="normal"><a href="#__codelineno-2-16">16</a></span>
<span class="normal"><a href="#__codelineno-2-17">17</a></span>
<span class="normal"><a href="#__codelineno-2-18">18</a></span>
<span class="normal"><a href="#__codelineno-2-19">19</a></span>
<span class="normal"><a href="#__codelineno-2-20">20</a></span>
<span class="normal"><a href="#__codelineno-2-21">21</a></span>
<span class="normal"><a href="#__codelineno-2-22">22</a></span>
<span class="normal"><a href="#__codelineno-2-23">23</a></span>
<span class="normal"><a href="#__codelineno-2-24">24</a></span>
<span class="normal"><a href="#__codelineno-2-25">25</a></span>
<span class="normal"><a href="#__codelineno-2-26">26</a></span>
<span class="normal"><a href="#__codelineno-2-27">27</a></span>
<span class="normal"><a href="#__codelineno-2-28">28</a></span>
<span class="normal"><a href="#__codelineno-2-29">29</a></span>
<span class="normal"><a href="#__codelineno-2-30">30</a></span>
<span class="normal"><a href="#__codelineno-2-31">31</a></span>
<span class="normal"><a href="#__codelineno-2-32">32</a></span>
<span class="normal"><a href="#__codelineno-2-33">33</a></span>
<span class="normal"><a href="#__codelineno-2-34">34</a></span>
<span class="normal"><a href="#__codelineno-2-35">35</a></span>
<span class="normal"><a href="#__codelineno-2-36">36</a></span>
<span class="normal"><a href="#__codelineno-2-37">37</a></span>
<span class="normal"><a href="#__codelineno-2-38">38</a></span>
<span class="normal"><a href="#__codelineno-2-39">39</a></span>
<span class="normal"><a href="#__codelineno-2-40">40</a></span>
<span class="normal"><a href="#__codelineno-2-41">41</a></span>
<span class="normal"><a href="#__codelineno-2-42">42</a></span>
<span class="normal"><a href="#__codelineno-2-43">43</a></span>
<span class="normal"><a href="#__codelineno-2-44">44</a></span>
<span class="normal"><a href="#__codelineno-2-45">45</a></span>
<span class="normal"><a href="#__codelineno-2-46">46</a></span>
<span class="normal"><a href="#__codelineno-2-47">47</a></span>
<span class="normal"><a href="#__codelineno-2-48">48</a></span>
<span class="normal"><a href="#__codelineno-2-49">49</a></span>
<span class="normal"><a href="#__codelineno-2-50">50</a></span>
<span class="normal"><a href="#__codelineno-2-51">51</a></span>
<span class="normal"><a href="#__codelineno-2-52">52</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="k">def</span> <span class="nf">plot_yolo_segment</span><span class="p">(</span><span class="n">img_filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">annot_filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">class_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a>    <span class="c1"># Reading the image file</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a>    <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img_filepath</span><span class="p">)</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a>    <span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a>    <span class="c1"># Reading the Yolo annotation</span>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">annot_filepath</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a>        <span class="n">norm_annot</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a>        <span class="n">norm_annot</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">norm_annot</span><span class="p">]</span>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a>        <span class="n">norm_annot</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">float</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">norm_annot</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="c1"># Last list is empty</span>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a>
<a id="__codelineno-2-12" name="__codelineno-2-12"></a>    <span class="c1"># Denormalizing the yolo annotation</span>
<a id="__codelineno-2-13" name="__codelineno-2-13"></a>    <span class="n">denorm_annot</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-2-14" name="__codelineno-2-14"></a>    <span class="k">for</span> <span class="n">annot</span> <span class="ow">in</span> <span class="n">norm_annot</span><span class="p">:</span>
<a id="__codelineno-2-15" name="__codelineno-2-15"></a>        <span class="n">annot_list</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-2-16" name="__codelineno-2-16"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">annot</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
<a id="__codelineno-2-17" name="__codelineno-2-17"></a>            <span class="k">if</span> <span class="n">i</span><span class="o">%</span><span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-2-18" name="__codelineno-2-18"></a>                <span class="n">annot_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span> <span class="o">*</span> <span class="n">W</span><span class="p">))</span>
<a id="__codelineno-2-19" name="__codelineno-2-19"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-2-20" name="__codelineno-2-20"></a>                <span class="n">annot_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span> <span class="o">*</span> <span class="n">H</span><span class="p">))</span>
<a id="__codelineno-2-21" name="__codelineno-2-21"></a>        <span class="n">denorm_annot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">annot_list</span><span class="p">)</span>
<a id="__codelineno-2-22" name="__codelineno-2-22"></a>
<a id="__codelineno-2-23" name="__codelineno-2-23"></a>    <span class="c1"># Converting the annot list into contours format</span>
<a id="__codelineno-2-24" name="__codelineno-2-24"></a>    <span class="n">denorm_annot_cont</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">denorm_annot</span><span class="p">)</span>
<a id="__codelineno-2-25" name="__codelineno-2-25"></a>
<a id="__codelineno-2-26" name="__codelineno-2-26"></a>    <span class="c1"># Getting the bounding box coords</span>
<a id="__codelineno-2-27" name="__codelineno-2-27"></a>    <span class="n">annot_box</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-2-28" name="__codelineno-2-28"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">denorm_annot_cont</span><span class="p">:</span>
<a id="__codelineno-2-29" name="__codelineno-2-29"></a>        <span class="n">annot_box</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">boundingRect</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
<a id="__codelineno-2-30" name="__codelineno-2-30"></a>
<a id="__codelineno-2-31" name="__codelineno-2-31"></a>    <span class="c1"># Visualizing the annotation on the image</span>
<a id="__codelineno-2-32" name="__codelineno-2-32"></a>    <span class="n">img_cp</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-2-33" name="__codelineno-2-33"></a>    <span class="n">cv2</span><span class="o">.</span><span class="n">drawContours</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">denorm_annot_cont</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-2-34" name="__codelineno-2-34"></a>    <span class="n">filled</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">addWeighted</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">img_cp</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="mf">0.3</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-2-35" name="__codelineno-2-35"></a>
<a id="__codelineno-2-36" name="__codelineno-2-36"></a>    <span class="c1"># Drawing the bounding box and text</span>
<a id="__codelineno-2-37" name="__codelineno-2-37"></a>    <span class="n">class_idx</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">norm_annot</span><span class="p">]</span>
<a id="__codelineno-2-38" name="__codelineno-2-38"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">box</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">annot_box</span><span class="p">):</span>
<a id="__codelineno-2-39" name="__codelineno-2-39"></a>        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">box</span>
<a id="__codelineno-2-40" name="__codelineno-2-40"></a>        <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">filled</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="p">,</span> <span class="n">y</span><span class="o">+</span><span class="n">h</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
<a id="__codelineno-2-41" name="__codelineno-2-41"></a>        <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">filled</span><span class="p">,</span> <span class="n">class_list</span><span class="p">[</span><span class="n">class_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">-</span><span class="mi">10</span> <span class="k">if</span> <span class="n">y</span><span class="o">-</span><span class="mi">10</span><span class="o">&gt;</span><span class="mi">10</span> <span class="k">else</span> <span class="n">y</span><span class="o">+</span><span class="mi">15</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_SIMPLEX</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-2-42" name="__codelineno-2-42"></a>
<a id="__codelineno-2-43" name="__codelineno-2-43"></a>    <span class="c1"># Plotting both the images</span>
<a id="__codelineno-2-44" name="__codelineno-2-44"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<a id="__codelineno-2-45" name="__codelineno-2-45"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-2-46" name="__codelineno-2-46"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img_cp</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">))</span>
<a id="__codelineno-2-47" name="__codelineno-2-47"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Original Image&#39;</span><span class="p">)</span>
<a id="__codelineno-2-48" name="__codelineno-2-48"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-2-49" name="__codelineno-2-49"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-2-50" name="__codelineno-2-50"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">filled</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">))</span>
<a id="__codelineno-2-51" name="__codelineno-2-51"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Annotated Image&#39;</span><span class="p">)</span>
<a id="__codelineno-2-52" name="__codelineno-2-52"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="kc">False</span><span class="p">);</span>
</code></pre></div></td></tr></table></div>
<figure>
<p><a class="glightbox" href="images/annot_img.png" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="Original and Annotated Image" src="images/annot_img.png" /></a>
  </p>
<figcaption>Comparison between Original Image and Annotated Image</figcaption>
</figure>
<p>You can find the complete code over <a href="https://github.com/JohnPPinto/food-geek-food-image-segmentation/blob/main/notebooks/03_processing_data_annotation.ipynb">here</a>.</p>
<h2 id="model-pipeline"><strong>Model Pipeline</strong></h2>
<p>Now comes the fun part, building a model that is capable of segmenting food images. Since I'm dealing with a classification problem along with instance segmentation and a reason to learn something new in computer vision, I will be using one of the current state-of-the-art models called YOLOv8 which is provided by Ultralytics. Similar to the previous generation of YOLO models, the configuration is similar but additional smartness is added to all the tasks and modes. You can check the whole documentation on their <a href="https://docs.ultralytics.com/">website</a> for quick reference.</p>
<p>Similar to the previous generation YOLO expects datasets to be in the following structure:</p>
<figure>
<p><a class="glightbox" href="images/yolo_structure.png" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="YOLO Dataset Structure" src="images/yolo_structure.png" width="350" /></a>
  </p>
<figcaption>YOLOv8 Dataset Structure</figcaption>
</figure>
<h3 id="model-training"><strong>Model Training</strong></h3>
<p>In my model training stage, my goal was to obtain a model that is powerful and lightweight and initially get a model as a baseline to work with, my goal was not to spend a lot of time in model experiments. So everything was dependent on the baseline model. Once the baseline model is successful, I can come back and improve the model. </p>
<p>To make this possible, I selected three sizes of the YOLOv8 model for the baseline experiments: Nano, Small, and Medium models. As the name states so does the size of the model. For monitoring the model training performance yolo provides tensorboard and Weights and biases, along with this I used ClearML, which does not need much user input and tracks the model automatically.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="c1"># Setting up clearML task</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="n">task</span> <span class="o">=</span> <span class="n">Task</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">project_name</span><span class="o">=</span><span class="s1">&#39;food_image_seg&#39;</span><span class="p">,</span> <span class="n">task_name</span><span class="o">=</span><span class="s1">&#39;exp1_yolov8n_5class_10percent&#39;</span><span class="p">)</span>
</code></pre></div>
<p>Loading and training the model method is the same. All of this can be done in a few lines of code.</p>
<p>While loading the model the default pre-trained weight file changes, if you need a nano model you use "yolov8n", for small you use "yolov8s" and for medium "yolov8m".</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="c1"># Loading the model - Experiment no.1</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="n">model</span> <span class="o">=</span> <span class="n">YOLO</span><span class="p">(</span><span class="s1">&#39;yolov8n-seg.pt&#39;</span><span class="p">)</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="c1"># Loading the model - Experiment no.2</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="n">model</span> <span class="o">=</span> <span class="n">YOLO</span><span class="p">(</span><span class="s1">&#39;yolov8s-seg.pt&#39;</span><span class="p">)</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="c1"># Loading the model - Experiment no.3</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="n">model</span> <span class="o">=</span> <span class="n">YOLO</span><span class="p">(</span><span class="s1">&#39;yolov8m-seg.pt&#39;</span><span class="p">)</span>
</code></pre></div>
<p>Model training does not change for any of the experiments, we define the configuration file in ".yaml", 512 for image size because all the images are of length 512, the model will run for 200 epochs a bigger run but to control the run I have given the patience 20 which will work with the early stopping callback.</p>
<p>In the .yaml file, I define the directories of the images and Yolo will automatically cache the labels based on the images directory. Along with this classes are defined and in the order that I have been using until now.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The path that needs to be mentioned in the .yaml file needs to be an absolute, not a relative path. There have been many issues related to this on the GitHub issue. This can be easy for local machines but for the cloud, it can be tough for getting the right path for Yolo to reach.</p>
</div>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">Model Training Code</label><label for="__tabbed_1_2">train_config.yaml</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c1"># Training the Yolo model</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s1">&#39;train_config.yaml&#39;</span><span class="p">,</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>                      <span class="n">imgsz</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span> 
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>                      <span class="n">epochs</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> 
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>                      <span class="n">patience</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>                      <span class="n">project</span><span class="o">=</span><span class="s1">&#39;train_logs_5class_10percent&#39;</span><span class="p">,</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>                      <span class="n">name</span><span class="o">=</span><span class="s1">&#39;exp1_yolov8n_5class_10percent&#39;</span><span class="p">)</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="c1"># Closing the clearML task</span>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a><span class="n">task</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="c1"># Path to the dataset</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;../../datasets&#39;</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="nt">train</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;images/train&#39;</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="nt">val</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;images/val&#39;</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="c1"># Classes details</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="nt">nc</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="nt">names</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;chicken_curry&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;chocolate_cake&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;hamburger&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;pizza&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;ramen&#39;</span><span class="p p-Indicator">]</span>
</code></pre></div>
</div>
</div>
</div>
<p>You can find the complete code over <a href="https://github.com/JohnPPinto/food-geek-food-image-segmentation/blob/main/notebooks/04_model_training.ipynb">here</a>.</p>
<h3 id="model-evaluation-and-export"><strong>Model Evaluation and Export</strong></h3>
<p>Now that the training was over it's time to understand which model works best with our goals. Model evaluation is a simple task where we will go through each model and check its result on an unseen dataset, in our case it's the validation or test dataset. Together with this we also need to randomly visualize the result which gives an out of box knowledge.</p>
<p>Yolo provides us with a simple function to validate and predict any images or videos using your desired models, these are smart functions and they know where to look for data, either way, these are stored in the model depending on the model type.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="n">model</span> <span class="o">=</span> <span class="n">YOLO</span><span class="p">(</span><span class="s1">&#39;train_logs_5class_10percent/exp1_yolov8n_5class_10percent/weights/best.pt&#39;</span><span class="p">)</span> <span class="c1"># Load the model</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="n">metrics</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">val</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;exp1_best_model&#39;</span><span class="p">)</span> <span class="c1"># Run the validation mode</span>
</code></pre></div>
<p>In Yolo visualizing the images is simple, once you get the result or the prediction for the images you can use the plot method provided by Yolo to visualize the predicted output.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-8-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-8-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-8-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-8-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-8-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-8-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-8-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-8-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-8-10">10</a></span>
<span class="normal"><a href="#__codelineno-8-11">11</a></span>
<span class="normal"><a href="#__codelineno-8-12">12</a></span>
<span class="normal"><a href="#__codelineno-8-13">13</a></span>
<span class="normal"><a href="#__codelineno-8-14">14</a></span>
<span class="normal"><a href="#__codelineno-8-15">15</a></span>
<span class="normal"><a href="#__codelineno-8-16">16</a></span>
<span class="normal"><a href="#__codelineno-8-17">17</a></span>
<span class="normal"><a href="#__codelineno-8-18">18</a></span>
<span class="normal"><a href="#__codelineno-8-19">19</a></span>
<span class="normal"><a href="#__codelineno-8-20">20</a></span>
<span class="normal"><a href="#__codelineno-8-21">21</a></span>
<span class="normal"><a href="#__codelineno-8-22">22</a></span>
<span class="normal"><a href="#__codelineno-8-23">23</a></span>
<span class="normal"><a href="#__codelineno-8-24">24</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="k">def</span> <span class="nf">predict_and_visualize</span><span class="p">(</span><span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">test_dirpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">conf</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a>    <span class="c1"># Getting the list of all the images in the directory</span>
<a id="__codelineno-8-3" name="__codelineno-8-3"></a>    <span class="n">imgs_list</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">test_dirpath</span><span class="p">,</span> <span class="s1">&#39;*/*&#39;</span><span class="p">))</span>
<a id="__codelineno-8-4" name="__codelineno-8-4"></a>
<a id="__codelineno-8-5" name="__codelineno-8-5"></a>    <span class="c1"># Getting a random sample from the image list</span>
<a id="__codelineno-8-6" name="__codelineno-8-6"></a>    <span class="n">rand_imgs</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">imgs_list</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<a id="__codelineno-8-7" name="__codelineno-8-7"></a>
<a id="__codelineno-8-8" name="__codelineno-8-8"></a>    <span class="c1"># Loading the model</span>
<a id="__codelineno-8-9" name="__codelineno-8-9"></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">YOLO</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>
<a id="__codelineno-8-10" name="__codelineno-8-10"></a>
<a id="__codelineno-8-11" name="__codelineno-8-11"></a>    <span class="c1"># Predicting and visualizing the random images</span>
<a id="__codelineno-8-12" name="__codelineno-8-12"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<a id="__codelineno-8-13" name="__codelineno-8-13"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
<a id="__codelineno-8-14" name="__codelineno-8-14"></a>        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-8-15" name="__codelineno-8-15"></a>
<a id="__codelineno-8-16" name="__codelineno-8-16"></a>        <span class="c1"># Reading the random images</span>
<a id="__codelineno-8-17" name="__codelineno-8-17"></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">rand_imgs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<a id="__codelineno-8-18" name="__codelineno-8-18"></a>
<a id="__codelineno-8-19" name="__codelineno-8-19"></a>        <span class="c1"># Predicting the images and plotting it</span>
<a id="__codelineno-8-20" name="__codelineno-8-20"></a><span class="hll">        <span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">conf</span><span class="o">=</span><span class="n">conf</span><span class="p">)</span> <span class="c1"># Using model predict mode</span>
</span><a id="__codelineno-8-21" name="__codelineno-8-21"></a><span class="hll">        <span class="n">pred_plot</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</span><a id="__codelineno-8-22" name="__codelineno-8-22"></a><span class="hll">        <span class="n">plot</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">pred_plot</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>
</span><a id="__codelineno-8-23" name="__codelineno-8-23"></a><span class="hll">        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">plot</span><span class="p">)</span>
</span><a id="__codelineno-8-24" name="__codelineno-8-24"></a><span class="hll">        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="kc">False</span><span class="p">);</span>
</span></code></pre></div></td></tr></table></div>
<p>Once all the evaluation is done, the model that is been selected for further process needs to be exported. Now, Yolo has mentioned in their documentation that they have multiple ways to export the model and all of this depends on the different criteria like on which system the model will run on eg. web application, mobile application, etc, and the device type in which it will run on whether CPU or GPU and many more.</p>
<p>In our case, I selected the ONNX format, which is capable of interoperability this means that the model is kind of universal in the AI world.</p>
<p>In Yolo exporting the model is as simple as other methods. You just need to call the mode and mention all the arguments and it's done.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="c1"># Exporting the experiment no. 2 best model</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="n">exp2_best_model_path</span> <span class="o">=</span> <span class="s1">&#39;train_logs_5class_10percent/exp2_yolov8s_5class_10percent/weights/best.pt&#39;</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="n">model</span> <span class="o">=</span> <span class="n">YOLO</span><span class="p">(</span><span class="n">exp2_best_model_path</span><span class="p">)</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="n">model</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;onnx&#39;</span><span class="p">,</span> <span class="n">imgsz</span><span class="o">=</span><span class="mi">512</span><span class="p">)</span>
</code></pre></div>
<p>You can find the complete code for model evaluation over <a href="https://github.com/JohnPPinto/food-geek-food-image-segmentation/blob/main/notebooks/05_model_evaluation.ipynb">here</a> and model export over <a href="https://github.com/JohnPPinto/food-geek-food-image-segmentation/blob/main/notebooks/06_model_export.ipynb">here</a>.</p>
<h2 id="deployment-pipeline"><strong>Deployment Pipeline</strong></h2>
<p>I'm not gonna lie, this was the scariest part of the whole project. Getting the data and model was something that I have been doing for some time, this pipeline is sort of like an adventure in the unknown. Starting this pipeline I had the model in the ONNX format, a format that I have never used and it's a new technology that has less information on the web, so I started to read the docs and learn new things.</p>
<p>In the deployment pipeline, my goal is straightforward, getting the model to work, the user gives an input (images of food) and the model does the prediction on the images which is returned as an output. Once the model was ready, the next was to build a web app that could let a user interact with it.</p>
<h3 id="adapting-to-onnx"><strong>Adapting to ONNX</strong></h3>
<p>Before getting started with all the explanations, if you are interested in the Yolov8 architecture you can take a look at the below image (The architecture is quite big so you will need to click the image and zoom it).</p>
<figure>
<p><a class="glightbox" href="images/onnx_model.png" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="Model Architecture" src="images/onnx_model.png" width="350" /></a>
  </p>
<figcaption>Yolov8 Model Architecture (Image from <a href="https://netron.app/" target="_blank">netron.app</a>)</figcaption>
</figure>
<p>First, we need to load the model with a few options like whether the inference will be done on CUDA or CPU and then we can read the metadata, inputs, and outputs data present in the model.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">engine.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-10-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-10-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-10-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-10-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-10-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-10-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-10-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-10-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-10-10">10</a></span>
<span class="normal"><a href="#__codelineno-10-11">11</a></span>
<span class="normal"><a href="#__codelineno-10-12">12</a></span>
<span class="normal"><a href="#__codelineno-10-13">13</a></span>
<span class="normal"><a href="#__codelineno-10-14">14</a></span>
<span class="normal"><a href="#__codelineno-10-15">15</a></span>
<span class="normal"><a href="#__codelineno-10-16">16</a></span>
<span class="normal"><a href="#__codelineno-10-17">17</a></span>
<span class="normal"><a href="#__codelineno-10-18">18</a></span>
<span class="normal"><a href="#__codelineno-10-19">19</a></span>
<span class="normal"><a href="#__codelineno-10-20">20</a></span>
<span class="normal"><a href="#__codelineno-10-21">21</a></span>
<span class="normal"><a href="#__codelineno-10-22">22</a></span>
<span class="normal"><a href="#__codelineno-10-23">23</a></span>
<span class="normal"><a href="#__codelineno-10-24">24</a></span>
<span class="normal"><a href="#__codelineno-10-25">25</a></span>
<span class="normal"><a href="#__codelineno-10-26">26</a></span>
<span class="normal"><a href="#__codelineno-10-27">27</a></span>
<span class="normal"><a href="#__codelineno-10-28">28</a></span>
<span class="normal"><a href="#__codelineno-10-29">29</a></span>
<span class="normal"><a href="#__codelineno-10-30">30</a></span>
<span class="normal"><a href="#__codelineno-10-31">31</a></span>
<span class="normal"><a href="#__codelineno-10-32">32</a></span>
<span class="normal"><a href="#__codelineno-10-33">33</a></span>
<span class="normal"><a href="#__codelineno-10-34">34</a></span>
<span class="normal"><a href="#__codelineno-10-35">35</a></span>
<span class="normal"><a href="#__codelineno-10-36">36</a></span>
<span class="normal"><a href="#__codelineno-10-37">37</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="k">class</span> <span class="nc">YoloSegPredict</span><span class="p">:</span>
<a id="__codelineno-10-2" name="__codelineno-10-2"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_path</span><span class="p">,</span> <span class="n">conf_threshold</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">,</span> <span class="n">iou_threshold</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">num_masks</span><span class="o">=</span><span class="mi">32</span><span class="p">):</span>
<a id="__codelineno-10-3" name="__codelineno-10-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">conf_threshold</span> <span class="o">=</span> <span class="n">conf_threshold</span>
<a id="__codelineno-10-4" name="__codelineno-10-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">iou_threshold</span> <span class="o">=</span> <span class="n">iou_threshold</span>
<a id="__codelineno-10-5" name="__codelineno-10-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_masks</span> <span class="o">=</span> <span class="n">num_masks</span>
<a id="__codelineno-10-6" name="__codelineno-10-6"></a>
<a id="__codelineno-10-7" name="__codelineno-10-7"></a>        <span class="c1"># Initializing the model</span>
<a id="__codelineno-10-8" name="__codelineno-10-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">initialize_model</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>
<a id="__codelineno-10-9" name="__codelineno-10-9"></a>
<a id="__codelineno-10-10" name="__codelineno-10-10"></a>    <span class="k">def</span> <span class="nf">initialize_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_path</span><span class="p">):</span>
<a id="__codelineno-10-11" name="__codelineno-10-11"></a>        <span class="n">EP_LIST</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CUDAExecutionProvider&#39;</span><span class="p">,</span> <span class="s1">&#39;CPUExecutionProvider&#39;</span><span class="p">]</span>
<a id="__codelineno-10-12" name="__codelineno-10-12"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">ort_session</span> <span class="o">=</span> <span class="n">onnxruntime</span><span class="o">.</span><span class="n">InferenceSession</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> 
</span><a id="__codelineno-10-13" name="__codelineno-10-13"></a><span class="hll">                                                        <span class="n">providers</span> <span class="o">=</span> <span class="n">EP_LIST</span><span class="p">)</span>
</span><a id="__codelineno-10-14" name="__codelineno-10-14"></a>        <span class="c1"># Get data from the model</span>
<a id="__codelineno-10-15" name="__codelineno-10-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">get_meta_details</span><span class="p">()</span>
<a id="__codelineno-10-16" name="__codelineno-10-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">get_input_details</span><span class="p">()</span>
<a id="__codelineno-10-17" name="__codelineno-10-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">get_output_details</span><span class="p">()</span>
<a id="__codelineno-10-18" name="__codelineno-10-18"></a>
<a id="__codelineno-10-19" name="__codelineno-10-19"></a>    <span class="k">def</span> <span class="nf">get_meta_details</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-10-20" name="__codelineno-10-20"></a>        <span class="c1"># Getting the model metadata.</span>
<a id="__codelineno-10-21" name="__codelineno-10-21"></a><span class="hll">        <span class="n">model_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ort_session</span><span class="o">.</span><span class="n">get_modelmeta</span><span class="p">()</span>
</span><a id="__codelineno-10-22" name="__codelineno-10-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">class_dict</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">model_meta</span><span class="o">.</span><span class="n">custom_metadata_map</span><span class="p">[</span><span class="s1">&#39;names&#39;</span><span class="p">])</span>
<a id="__codelineno-10-23" name="__codelineno-10-23"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">class_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<a id="__codelineno-10-24" name="__codelineno-10-24"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_list</span>
<a id="__codelineno-10-25" name="__codelineno-10-25"></a>
<a id="__codelineno-10-26" name="__codelineno-10-26"></a>    <span class="k">def</span> <span class="nf">get_input_details</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-10-27" name="__codelineno-10-27"></a>        <span class="c1"># Getting the input data</span>
<a id="__codelineno-10-28" name="__codelineno-10-28"></a><span class="hll">        <span class="n">model_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ort_session</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">()</span>
</span><a id="__codelineno-10-29" name="__codelineno-10-29"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">model_inputs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model_inputs</span><span class="p">))]</span>
<a id="__codelineno-10-30" name="__codelineno-10-30"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span> <span class="o">=</span> <span class="n">model_inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
<a id="__codelineno-10-31" name="__codelineno-10-31"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<a id="__codelineno-10-32" name="__codelineno-10-32"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">input_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<a id="__codelineno-10-33" name="__codelineno-10-33"></a>
<a id="__codelineno-10-34" name="__codelineno-10-34"></a>    <span class="k">def</span> <span class="nf">get_output_details</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-10-35" name="__codelineno-10-35"></a>        <span class="c1"># Getting the output data</span>
<a id="__codelineno-10-36" name="__codelineno-10-36"></a><span class="hll">        <span class="n">model_outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ort_session</span><span class="o">.</span><span class="n">get_outputs</span><span class="p">()</span>
</span><a id="__codelineno-10-37" name="__codelineno-10-37"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">output_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">model_outputs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model_outputs</span><span class="p">))]</span>
</code></pre></div></td></tr></table></div>
<p>Now, that we have the model ready for action, we will need an image as an input for the model to predict on. First, we prepare the image, making it compatible with the model input requirements, then we perform the inference on the prepared image tensor and we process the output as per our need, in this case getting the best box and segment mask.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">engine.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-39">39</a></span>
<span class="normal"><a href="#__codelineno-11-40">40</a></span>
<span class="normal"><a href="#__codelineno-11-41">41</a></span>
<span class="normal"><a href="#__codelineno-11-42">42</a></span>
<span class="normal"><a href="#__codelineno-11-43">43</a></span>
<span class="normal"><a href="#__codelineno-11-44">44</a></span>
<span class="normal"><a href="#__codelineno-11-45">45</a></span>
<span class="normal"><a href="#__codelineno-11-46">46</a></span>
<span class="normal"><a href="#__codelineno-11-47">47</a></span>
<span class="normal"><a href="#__codelineno-11-48">48</a></span>
<span class="normal"><a href="#__codelineno-11-49">49</a></span>
<span class="normal"><a href="#__codelineno-11-50">50</a></span>
<span class="normal"><a href="#__codelineno-11-51">51</a></span>
<span class="normal"><a href="#__codelineno-11-52">52</a></span>
<span class="normal"><a href="#__codelineno-11-53">53</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-11-39" name="__codelineno-11-39"></a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
<a id="__codelineno-11-40" name="__codelineno-11-40"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">segment_objects</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
<a id="__codelineno-11-41" name="__codelineno-11-41"></a>
<a id="__codelineno-11-42" name="__codelineno-11-42"></a>    <span class="k">def</span> <span class="nf">segment_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
<a id="__codelineno-11-43" name="__codelineno-11-43"></a>        <span class="c1"># Prepare the image array as an input tensor.</span>
<a id="__codelineno-11-44" name="__codelineno-11-44"></a>        <span class="n">input_tensor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_img_resized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_input</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
<a id="__codelineno-11-45" name="__codelineno-11-45"></a>
<a id="__codelineno-11-46" name="__codelineno-11-46"></a>        <span class="c1"># Perform inference on the image</span>
<a id="__codelineno-11-47" name="__codelineno-11-47"></a>        <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="p">(</span><span class="n">input_tensor</span><span class="p">)</span>
<a id="__codelineno-11-48" name="__codelineno-11-48"></a>
<a id="__codelineno-11-49" name="__codelineno-11-49"></a>        <span class="c1"># Extract prediction data</span>
<a id="__codelineno-11-50" name="__codelineno-11-50"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_ids</span><span class="p">,</span> <span class="n">mask_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_box_output</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-11-51" name="__codelineno-11-51"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mask_maps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_mask_output</span><span class="p">(</span><span class="n">mask_pred</span><span class="p">,</span> <span class="n">outputs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-11-52" name="__codelineno-11-52"></a>
<a id="__codelineno-11-53" name="__codelineno-11-53"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_img_resized</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">boxes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_ids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_maps</span>
</code></pre></div></td></tr></table></div>
<p>The image preparing stage is similar to that of the image preparation done in PyTorch, the image tensor is initially reshaped to the model input shape then the tensor is normalized between the range of 0 and 1, then the tensor is permuted into the arrangement of [channels, height, width] and finally the tensor is added with a new axis at the start to indicate it as a batch tensor.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">engine.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-55">55</a></span>
<span class="normal"><a href="#__codelineno-12-56">56</a></span>
<span class="normal"><a href="#__codelineno-12-57">57</a></span>
<span class="normal"><a href="#__codelineno-12-58">58</a></span>
<span class="normal"><a href="#__codelineno-12-59">59</a></span>
<span class="normal"><a href="#__codelineno-12-60">60</a></span>
<span class="normal"><a href="#__codelineno-12-61">61</a></span>
<span class="normal"><a href="#__codelineno-12-62">62</a></span>
<span class="normal"><a href="#__codelineno-12-63">63</a></span>
<span class="normal"><a href="#__codelineno-12-64">64</a></span>
<span class="normal"><a href="#__codelineno-12-65">65</a></span>
<span class="normal"><a href="#__codelineno-12-66">66</a></span>
<span class="normal"><a href="#__codelineno-12-67">67</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-12-55" name="__codelineno-12-55"></a>    <span class="k">def</span> <span class="nf">prepare_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
<a id="__codelineno-12-56" name="__codelineno-12-56"></a>        <span class="c1"># Getting image info</span>
<a id="__codelineno-12-57" name="__codelineno-12-57"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">image_height</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_width</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
<a id="__codelineno-12-58" name="__codelineno-12-58"></a>
<a id="__codelineno-12-59" name="__codelineno-12-59"></a>        <span class="c1"># Resize input image to input size</span>
<a id="__codelineno-12-60" name="__codelineno-12-60"></a>        <span class="n">input_img_resized</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_height</span><span class="p">))</span>
<a id="__codelineno-12-61" name="__codelineno-12-61"></a>
<a id="__codelineno-12-62" name="__codelineno-12-62"></a>        <span class="c1"># Preprocessing the input image</span>
<a id="__codelineno-12-63" name="__codelineno-12-63"></a>        <span class="n">input_img</span> <span class="o">=</span> <span class="n">input_img_resized</span> <span class="o">/</span> <span class="mf">255.0</span> <span class="c1"># Normalizing</span>
<a id="__codelineno-12-64" name="__codelineno-12-64"></a>        <span class="n">input_img</span> <span class="o">=</span> <span class="n">input_img</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-12-65" name="__codelineno-12-65"></a>        <span class="n">input_tensor</span> <span class="o">=</span> <span class="n">input_img</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-12-66" name="__codelineno-12-66"></a>
<a id="__codelineno-12-67" name="__codelineno-12-67"></a>        <span class="k">return</span> <span class="n">input_tensor</span><span class="p">,</span> <span class="n">input_img_resized</span>
</code></pre></div></td></tr></table></div>
<p>Once I have the model ready and the image ready, then I use the model to predict the image. </p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">engine.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-69">69</a></span>
<span class="normal"><a href="#__codelineno-13-70">70</a></span>
<span class="normal"><a href="#__codelineno-13-71">71</a></span>
<span class="normal"><a href="#__codelineno-13-72">72</a></span>
<span class="normal"><a href="#__codelineno-13-73">73</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-13-69" name="__codelineno-13-69"></a>    <span class="k">def</span> <span class="nf">inference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_tensor</span><span class="p">):</span>
<a id="__codelineno-13-70" name="__codelineno-13-70"></a>        <span class="c1"># Predicting using the Yolo onnx model</span>
<a id="__codelineno-13-71" name="__codelineno-13-71"></a>        <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ort_session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_names</span><span class="p">,</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">input_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">input_tensor</span><span class="p">})</span>
<a id="__codelineno-13-72" name="__codelineno-13-72"></a>
<a id="__codelineno-13-73" name="__codelineno-13-73"></a>        <span class="k">return</span> <span class="n">outputs</span>
</code></pre></div></td></tr></table></div>
<p>Once we get the prediction result, we move forward, toward extracting and processing those predictions. After inferring any images our model gives out two outputs:</p>
<ol>
<li>
<p>The output contains all the possible prediction boxes and masks, the format is such a way: The first four are for the boxes coordinate, the next is the probability scores or confidence scores for all the classes in our case it is 5 classes and the remaining are sort of mask coordinates which is 32 by default by Yolo.</p>
</li>
<li>
<p>The second output contains 32 different grayscale mask images that are predicted by the model, the shape of the output is [1, 32, 128, 128] here the mask images are in 128 X 128 shape.</p>
</li>
</ol>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>The 32 different images come from the convolution layer having 32 filters. You can check this in the above image of Yolo Architecture.</p>
</div>
<p>Now, that we know everything about the outputs, it's time to extract the one that has the best prediction. Starting with the box prediction. I extract the classes, boxes, and mask values based on the highest confidence score. Once the boxes are extracted they are processed into the non-maximum suppression algorithm, which gives only the best predicted box coordinates rest of the boxes are suppressed.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:6"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><input id="__tabbed_2_2" name="__tabbed_2" type="radio" /><input id="__tabbed_2_3" name="__tabbed_2" type="radio" /><input id="__tabbed_2_4" name="__tabbed_2" type="radio" /><input id="__tabbed_2_5" name="__tabbed_2" type="radio" /><input id="__tabbed_2_6" name="__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="__tabbed_2_1">engine.py</label><label for="__tabbed_2_2">rescale_boxes</label><label for="__tabbed_2_3">bbox_yolo_to_pascal</label><label for="__tabbed_2_4">clip_bbox</label><label for="__tabbed_2_5">compute_nms</label><label for="__tabbed_2_6">compute_iou</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-14-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-14-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-14-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-14-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-14-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-14-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-14-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-14-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-14-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-14-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-14-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-14-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-14-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-14-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-14-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-14-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-14-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-14-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-14-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-14-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-14-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-14-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-14-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-14-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-14-100">100</a></span>
<span class="normal"><a href="#__codelineno-14-101">101</a></span>
<span class="normal"><a href="#__codelineno-14-102">102</a></span>
<span class="normal"><a href="#__codelineno-14-103">103</a></span>
<span class="normal"><a href="#__codelineno-14-104">104</a></span>
<span class="normal"><a href="#__codelineno-14-105">105</a></span>
<span class="normal"><a href="#__codelineno-14-106">106</a></span>
<span class="normal"><a href="#__codelineno-14-107">107</a></span>
<span class="normal"><a href="#__codelineno-14-108">108</a></span>
<span class="normal"><a href="#__codelineno-14-109">109</a></span>
<span class="normal"><a href="#__codelineno-14-110">110</a></span>
<span class="normal"><a href="#__codelineno-14-111">111</a></span>
<span class="normal"><a href="#__codelineno-14-112">112</a></span>
<span class="normal"><a href="#__codelineno-14-113">113</a></span>
<span class="normal"><a href="#__codelineno-14-114">114</a></span>
<span class="normal"><a href="#__codelineno-14-115">115</a></span>
<span class="normal"><a href="#__codelineno-14-116">116</a></span>
<span class="normal"><a href="#__codelineno-14-117">117</a></span>
<span class="normal"><a href="#__codelineno-14-118">118</a></span>
<span class="normal"><a href="#__codelineno-14-119">119</a></span>
<span class="normal"><a href="#__codelineno-14-120">120</a></span>
<span class="normal"><a href="#__codelineno-14-121">121</a></span>
<span class="normal"><a href="#__codelineno-14-122">122</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-14-75" name="__codelineno-14-75"></a>    <span class="k">def</span> <span class="nf">process_box_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">box_output</span><span class="p">):</span>
<a id="__codelineno-14-76" name="__codelineno-14-76"></a>        <span class="c1"># Extracting predictions from box outputs</span>
<a id="__codelineno-14-77" name="__codelineno-14-77"></a>        <span class="n">predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">box_output</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
<a id="__codelineno-14-78" name="__codelineno-14-78"></a>        <span class="n">num_classes</span> <span class="o">=</span> <span class="n">box_output</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_masks</span> <span class="o">-</span> <span class="mi">4</span> <span class="c1"># box data - mask data - box coords</span>
<a id="__codelineno-14-79" name="__codelineno-14-79"></a>
<a id="__codelineno-14-80" name="__codelineno-14-80"></a>        <span class="c1"># Filter out confidence scores below threshold</span>
<a id="__codelineno-14-81" name="__codelineno-14-81"></a><span class="hll">        <span class="n">scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">predictions</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">:</span><span class="mi">4</span><span class="o">+</span><span class="n">num_classes</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><a id="__codelineno-14-82" name="__codelineno-14-82"></a><span class="hll">        <span class="n">predictions</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="n">scores</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf_threshold</span><span class="p">,</span> <span class="p">:]</span>
</span><a id="__codelineno-14-83" name="__codelineno-14-83"></a><span class="hll">        <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="n">scores</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf_threshold</span><span class="p">]</span>
</span><a id="__codelineno-14-84" name="__codelineno-14-84"></a>
<a id="__codelineno-14-85" name="__codelineno-14-85"></a>        <span class="c1"># Validating for no scores</span>
<a id="__codelineno-14-86" name="__codelineno-14-86"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-14-87" name="__codelineno-14-87"></a>            <span class="k">return</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
<a id="__codelineno-14-88" name="__codelineno-14-88"></a>
<a id="__codelineno-14-89" name="__codelineno-14-89"></a>        <span class="c1"># Separating the prediction from the first output</span>
<a id="__codelineno-14-90" name="__codelineno-14-90"></a>        <span class="n">box_predictions</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="n">num_classes</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span>
<a id="__codelineno-14-91" name="__codelineno-14-91"></a>        <span class="n">mask_predictions</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">+</span><span class="mi">4</span><span class="p">:]</span>
<a id="__codelineno-14-92" name="__codelineno-14-92"></a>
<a id="__codelineno-14-93" name="__codelineno-14-93"></a>        <span class="c1"># Getting class with the highest confidence score</span>
<a id="__codelineno-14-94" name="__codelineno-14-94"></a>        <span class="n">class_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">box_predictions</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-14-95" name="__codelineno-14-95"></a>
<a id="__codelineno-14-96" name="__codelineno-14-96"></a>        <span class="c1"># Getting the bounding box for all the objects</span>
<a id="__codelineno-14-97" name="__codelineno-14-97"></a><span class="hll">        <span class="n">boxes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_boxes</span><span class="p">(</span><span class="n">box_predictions</span><span class="p">)</span>
</span><a id="__codelineno-14-98" name="__codelineno-14-98"></a>
<a id="__codelineno-14-99" name="__codelineno-14-99"></a>        <span class="c1"># Apply Non Maximum Suppression to suppress overlapping box</span>
<a id="__codelineno-14-100" name="__codelineno-14-100"></a><span class="hll">        <span class="n">indices</span> <span class="o">=</span> <span class="n">compute_nms</span><span class="p">(</span><span class="n">boxes</span><span class="o">=</span><span class="n">boxes</span><span class="p">,</span> 
</span><a id="__codelineno-14-101" name="__codelineno-14-101"></a><span class="hll">                              <span class="n">scores</span><span class="o">=</span><span class="n">scores</span><span class="p">,</span> 
</span><a id="__codelineno-14-102" name="__codelineno-14-102"></a><span class="hll">                              <span class="n">iou_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">iou_threshold</span><span class="p">)</span>
</span><a id="__codelineno-14-103" name="__codelineno-14-103"></a>        <span class="k">return</span> <span class="n">boxes</span><span class="p">[</span><span class="n">indices</span><span class="p">],</span> <span class="n">scores</span><span class="p">[</span><span class="n">indices</span><span class="p">],</span> <span class="n">class_ids</span><span class="p">[</span><span class="n">indices</span><span class="p">],</span> <span class="n">mask_predictions</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
<a id="__codelineno-14-104" name="__codelineno-14-104"></a>
<a id="__codelineno-14-105" name="__codelineno-14-105"></a>    <span class="k">def</span> <span class="nf">extract_boxes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">box_predictions</span><span class="p">):</span>
<a id="__codelineno-14-106" name="__codelineno-14-106"></a>        <span class="c1"># Extract box from predictions</span>
<a id="__codelineno-14-107" name="__codelineno-14-107"></a>        <span class="n">boxes</span> <span class="o">=</span> <span class="n">box_predictions</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">4</span><span class="p">]</span>
<a id="__codelineno-14-108" name="__codelineno-14-108"></a>
<a id="__codelineno-14-109" name="__codelineno-14-109"></a><span class="hll">        <span class="c1"># Scale boxes to original image dimension</span>
</span><a id="__codelineno-14-110" name="__codelineno-14-110"></a><span class="hll">        <span class="n">boxes</span> <span class="o">=</span> <span class="n">rescale_boxes</span><span class="p">(</span><span class="n">boxes</span><span class="o">=</span><span class="n">boxes</span><span class="p">,</span> 
</span><a id="__codelineno-14-111" name="__codelineno-14-111"></a><span class="hll">                              <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_height</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_width</span><span class="p">),</span> 
</span><a id="__codelineno-14-112" name="__codelineno-14-112"></a><span class="hll">                              <span class="n">output_shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_height</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_width</span><span class="p">))</span>
</span><a id="__codelineno-14-113" name="__codelineno-14-113"></a><span class="hll">
</span><a id="__codelineno-14-114" name="__codelineno-14-114"></a><span class="hll">        <span class="c1"># Convert the boxes to pascal voc format</span>
</span><a id="__codelineno-14-115" name="__codelineno-14-115"></a><span class="hll">        <span class="n">boxes</span> <span class="o">=</span> <span class="n">bbox_yolo_to_pascal</span><span class="p">(</span><span class="n">boxes</span><span class="o">=</span><span class="n">boxes</span><span class="p">)</span>
</span><a id="__codelineno-14-116" name="__codelineno-14-116"></a><span class="hll">
</span><a id="__codelineno-14-117" name="__codelineno-14-117"></a><span class="hll">        <span class="c1"># Clipping the boxes range to a image limit</span>
</span><a id="__codelineno-14-118" name="__codelineno-14-118"></a><span class="hll">        <span class="n">boxes</span> <span class="o">=</span> <span class="n">clip_bbox</span><span class="p">(</span><span class="n">boxes</span><span class="o">=</span><span class="n">boxes</span><span class="p">,</span> 
</span><a id="__codelineno-14-119" name="__codelineno-14-119"></a><span class="hll">                          <span class="n">height</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">image_height</span><span class="p">,</span> 
</span><a id="__codelineno-14-120" name="__codelineno-14-120"></a><span class="hll">                          <span class="n">width</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">image_width</span><span class="p">)</span>
</span><a id="__codelineno-14-121" name="__codelineno-14-121"></a>
<a id="__codelineno-14-122" name="__codelineno-14-122"></a>        <span class="k">return</span> <span class="n">boxes</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-15-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-15-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-15-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-15-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-15-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-15-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-15-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-15-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-15-10">10</a></span>
<span class="normal"><a href="#__codelineno-15-11">11</a></span>
<span class="normal"><a href="#__codelineno-15-12">12</a></span>
<span class="normal"><a href="#__codelineno-15-13">13</a></span>
<span class="normal"><a href="#__codelineno-15-14">14</a></span>
<span class="normal"><a href="#__codelineno-15-15">15</a></span>
<span class="normal"><a href="#__codelineno-15-16">16</a></span>
<span class="normal"><a href="#__codelineno-15-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="c1"># Rescale any bounding box</span>
<a id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="k">def</span> <span class="nf">rescale_boxes</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">input_shape</span><span class="p">,</span> <span class="n">output_shape</span><span class="p">):</span>
<a id="__codelineno-15-3" name="__codelineno-15-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-15-4" name="__codelineno-15-4"></a><span class="sd">    This functions helps in re-scaling bounding box from one object to another.</span>
<a id="__codelineno-15-5" name="__codelineno-15-5"></a>
<a id="__codelineno-15-6" name="__codelineno-15-6"></a><span class="sd">    Parameters:</span>
<a id="__codelineno-15-7" name="__codelineno-15-7"></a><span class="sd">        boxes: An array containing the values of the bounding box.</span>
<a id="__codelineno-15-8" name="__codelineno-15-8"></a><span class="sd">        input_shape: A tuple or list containing values of the original object shape. E.g. (height, width)</span>
<a id="__codelineno-15-9" name="__codelineno-15-9"></a><span class="sd">        output_shape: A tuple or list containing values of the output object shape. E.g. (height, width)</span>
<a id="__codelineno-15-10" name="__codelineno-15-10"></a>
<a id="__codelineno-15-11" name="__codelineno-15-11"></a><span class="sd">    Returns:</span>
<a id="__codelineno-15-12" name="__codelineno-15-12"></a><span class="sd">        boxes: An array containing the values of the rescale boxes.</span>
<a id="__codelineno-15-13" name="__codelineno-15-13"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-15-14" name="__codelineno-15-14"></a>    <span class="n">input_shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">input_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">input_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">input_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
<a id="__codelineno-15-15" name="__codelineno-15-15"></a>    <span class="n">boxes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">input_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-15-16" name="__codelineno-15-16"></a>    <span class="n">boxes</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">output_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">output_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">output_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">output_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
<a id="__codelineno-15-17" name="__codelineno-15-17"></a>    <span class="k">return</span> <span class="n">boxes</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-16-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-16-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-16-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-16-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-16-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-16-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-16-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-16-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-16-10">10</a></span>
<span class="normal"><a href="#__codelineno-16-11">11</a></span>
<span class="normal"><a href="#__codelineno-16-12">12</a></span>
<span class="normal"><a href="#__codelineno-16-13">13</a></span>
<span class="normal"><a href="#__codelineno-16-14">14</a></span>
<span class="normal"><a href="#__codelineno-16-15">15</a></span>
<span class="normal"><a href="#__codelineno-16-16">16</a></span>
<span class="normal"><a href="#__codelineno-16-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="c1"># Convert bounding box from YOLO format (x_c, y_c, w, h) into Pascal VOC format (x1, y1, x2, y2)</span>
<a id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="k">def</span> <span class="nf">bbox_yolo_to_pascal</span><span class="p">(</span><span class="n">boxes</span><span class="p">):</span>
<a id="__codelineno-16-3" name="__codelineno-16-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-16-4" name="__codelineno-16-4"></a><span class="sd">    This function helps in converting the bounding box format from YOLO to Pascal VOC.</span>
<a id="__codelineno-16-5" name="__codelineno-16-5"></a>
<a id="__codelineno-16-6" name="__codelineno-16-6"></a><span class="sd">    Parameters:</span>
<a id="__codelineno-16-7" name="__codelineno-16-7"></a><span class="sd">        boxes: An array containing the values of the bounding box in YOLO format.</span>
<a id="__codelineno-16-8" name="__codelineno-16-8"></a>
<a id="__codelineno-16-9" name="__codelineno-16-9"></a><span class="sd">    Returns:</span>
<a id="__codelineno-16-10" name="__codelineno-16-10"></a><span class="sd">        boxes_cp: An array containing the values of the bounding box in Pascal VOC format.</span>
<a id="__codelineno-16-11" name="__codelineno-16-11"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-16-12" name="__codelineno-16-12"></a>    <span class="n">boxes_cp</span> <span class="o">=</span> <span class="n">boxes</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-16-13" name="__codelineno-16-13"></a>    <span class="n">boxes_cp</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">boxes</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
<a id="__codelineno-16-14" name="__codelineno-16-14"></a>    <span class="n">boxes_cp</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">boxes</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
<a id="__codelineno-16-15" name="__codelineno-16-15"></a>    <span class="n">boxes_cp</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">boxes</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
<a id="__codelineno-16-16" name="__codelineno-16-16"></a>    <span class="n">boxes_cp</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">boxes</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
<a id="__codelineno-16-17" name="__codelineno-16-17"></a>    <span class="k">return</span> <span class="n">boxes_cp</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-17-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-17-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-17-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-17-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-17-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-17-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-17-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-17-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-17-10">10</a></span>
<span class="normal"><a href="#__codelineno-17-11">11</a></span>
<span class="normal"><a href="#__codelineno-17-12">12</a></span>
<span class="normal"><a href="#__codelineno-17-13">13</a></span>
<span class="normal"><a href="#__codelineno-17-14">14</a></span>
<span class="normal"><a href="#__codelineno-17-15">15</a></span>
<span class="normal"><a href="#__codelineno-17-16">16</a></span>
<span class="normal"><a href="#__codelineno-17-17">17</a></span>
<span class="normal"><a href="#__codelineno-17-18">18</a></span>
<span class="normal"><a href="#__codelineno-17-19">19</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="c1"># Clipping the bounding box values</span>
<a id="__codelineno-17-2" name="__codelineno-17-2"></a><span class="k">def</span> <span class="nf">clip_bbox</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">):</span>
<a id="__codelineno-17-3" name="__codelineno-17-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-17-4" name="__codelineno-17-4"></a><span class="sd">    This function helps in clipping the values of the bounding box.</span>
<a id="__codelineno-17-5" name="__codelineno-17-5"></a>
<a id="__codelineno-17-6" name="__codelineno-17-6"></a><span class="sd">    Parameters:</span>
<a id="__codelineno-17-7" name="__codelineno-17-7"></a><span class="sd">        boxes: An array containing the values of the bounding box. </span>
<a id="__codelineno-17-8" name="__codelineno-17-8"></a><span class="sd">        height: An int value of the height of a Image or Frame.</span>
<a id="__codelineno-17-9" name="__codelineno-17-9"></a><span class="sd">        width: An int value of the width of a Image or Frame.</span>
<a id="__codelineno-17-10" name="__codelineno-17-10"></a>
<a id="__codelineno-17-11" name="__codelineno-17-11"></a><span class="sd">    Return:</span>
<a id="__codelineno-17-12" name="__codelineno-17-12"></a><span class="sd">        clip_boxes: An array containing the clipped values of the bounding box.</span>
<a id="__codelineno-17-13" name="__codelineno-17-13"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-17-14" name="__codelineno-17-14"></a>    <span class="n">clip_boxes</span> <span class="o">=</span> <span class="n">boxes</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-17-15" name="__codelineno-17-15"></a>    <span class="n">clip_boxes</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">boxes</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>
<a id="__codelineno-17-16" name="__codelineno-17-16"></a>    <span class="n">clip_boxes</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">boxes</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
<a id="__codelineno-17-17" name="__codelineno-17-17"></a>    <span class="n">clip_boxes</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">boxes</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>
<a id="__codelineno-17-18" name="__codelineno-17-18"></a>    <span class="n">clip_boxes</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">boxes</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
<a id="__codelineno-17-19" name="__codelineno-17-19"></a>    <span class="k">return</span> <span class="n">clip_boxes</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-18-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-18-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-18-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-18-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-18-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-18-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-18-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-18-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-18-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-18-10">10</a></span>
<span class="normal"><a href="#__codelineno-18-11">11</a></span>
<span class="normal"><a href="#__codelineno-18-12">12</a></span>
<span class="normal"><a href="#__codelineno-18-13">13</a></span>
<span class="normal"><a href="#__codelineno-18-14">14</a></span>
<span class="normal"><a href="#__codelineno-18-15">15</a></span>
<span class="normal"><a href="#__codelineno-18-16">16</a></span>
<span class="normal"><a href="#__codelineno-18-17">17</a></span>
<span class="normal"><a href="#__codelineno-18-18">18</a></span>
<span class="normal"><a href="#__codelineno-18-19">19</a></span>
<span class="normal"><a href="#__codelineno-18-20">20</a></span>
<span class="normal"><a href="#__codelineno-18-21">21</a></span>
<span class="normal"><a href="#__codelineno-18-22">22</a></span>
<span class="normal"><a href="#__codelineno-18-23">23</a></span>
<span class="normal"><a href="#__codelineno-18-24">24</a></span>
<span class="normal"><a href="#__codelineno-18-25">25</a></span>
<span class="normal"><a href="#__codelineno-18-26">26</a></span>
<span class="normal"><a href="#__codelineno-18-27">27</a></span>
<span class="normal"><a href="#__codelineno-18-28">28</a></span>
<span class="normal"><a href="#__codelineno-18-29">29</a></span>
<span class="normal"><a href="#__codelineno-18-30">30</a></span>
<span class="normal"><a href="#__codelineno-18-31">31</a></span>
<span class="normal"><a href="#__codelineno-18-32">32</a></span>
<span class="normal"><a href="#__codelineno-18-33">33</a></span>
<span class="normal"><a href="#__codelineno-18-34">34</a></span>
<span class="normal"><a href="#__codelineno-18-35">35</a></span>
<span class="normal"><a href="#__codelineno-18-36">36</a></span>
<span class="normal"><a href="#__codelineno-18-37">37</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="c1"># Computing Non Maximum Suppression on all the bounding box</span>
<a id="__codelineno-18-2" name="__codelineno-18-2"></a><span class="k">def</span> <span class="nf">compute_nms</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">iou_threshold</span><span class="p">):</span>
<a id="__codelineno-18-3" name="__codelineno-18-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-18-4" name="__codelineno-18-4"></a><span class="sd">    This function helps in computing the Non Maximum Suppression on the </span>
<a id="__codelineno-18-5" name="__codelineno-18-5"></a><span class="sd">    predicted bounding boxes.</span>
<a id="__codelineno-18-6" name="__codelineno-18-6"></a>
<a id="__codelineno-18-7" name="__codelineno-18-7"></a><span class="sd">    Parameters:</span>
<a id="__codelineno-18-8" name="__codelineno-18-8"></a><span class="sd">        boxes: An array containing the values of the bounding boxes.</span>
<a id="__codelineno-18-9" name="__codelineno-18-9"></a><span class="sd">        scores: An array containing the values of the confidence scores</span>
<a id="__codelineno-18-10" name="__codelineno-18-10"></a><span class="sd">                for each bounding box.</span>
<a id="__codelineno-18-11" name="__codelineno-18-11"></a><span class="sd">        iou_threshold: A float value to suppress the bounding box.</span>
<a id="__codelineno-18-12" name="__codelineno-18-12"></a><span class="sd">                       Value should be within the range (0, 1).</span>
<a id="__codelineno-18-13" name="__codelineno-18-13"></a>
<a id="__codelineno-18-14" name="__codelineno-18-14"></a><span class="sd">    Returns: </span>
<a id="__codelineno-18-15" name="__codelineno-18-15"></a><span class="sd">        Keep_boxes: A list containing the index for the boxes and scores </span>
<a id="__codelineno-18-16" name="__codelineno-18-16"></a><span class="sd">                    array after computing Non Maximum Suppression.</span>
<a id="__codelineno-18-17" name="__codelineno-18-17"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-18-18" name="__codelineno-18-18"></a>    <span class="c1"># Getting the list of indices of sorted scores - descending order</span>
<a id="__codelineno-18-19" name="__codelineno-18-19"></a>    <span class="n">sorted_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">scores</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-18-20" name="__codelineno-18-20"></a>
<a id="__codelineno-18-21" name="__codelineno-18-21"></a>    <span class="c1"># Looping through the indices and computing nms</span>
<a id="__codelineno-18-22" name="__codelineno-18-22"></a>    <span class="n">keep_boxes</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-18-23" name="__codelineno-18-23"></a>    <span class="k">while</span> <span class="n">sorted_indices</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-18-24" name="__codelineno-18-24"></a>        <span class="c1"># Picking the box with best score</span>
<a id="__codelineno-18-25" name="__codelineno-18-25"></a>        <span class="n">box_id</span> <span class="o">=</span> <span class="n">sorted_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-18-26" name="__codelineno-18-26"></a>        <span class="n">keep_boxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box_id</span><span class="p">)</span>
<a id="__codelineno-18-27" name="__codelineno-18-27"></a>
<a id="__codelineno-18-28" name="__codelineno-18-28"></a>        <span class="c1"># Compute the IoU of the picked box with the rest of the boxes</span>
<a id="__codelineno-18-29" name="__codelineno-18-29"></a><span class="hll">        <span class="n">ious</span> <span class="o">=</span> <span class="n">compute_iou</span><span class="p">(</span><span class="n">box</span><span class="o">=</span><span class="n">boxes</span><span class="p">[</span><span class="n">box_id</span><span class="p">,</span> <span class="p">:],</span> <span class="n">boxes</span><span class="o">=</span><span class="n">boxes</span><span class="p">[</span><span class="n">sorted_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="p">:])</span>
</span><a id="__codelineno-18-30" name="__codelineno-18-30"></a>
<a id="__codelineno-18-31" name="__codelineno-18-31"></a>        <span class="c1"># Remove boxes with IoU over the threshold</span>
<a id="__codelineno-18-32" name="__codelineno-18-32"></a>        <span class="n">keep_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ious</span> <span class="o">&lt;</span> <span class="n">iou_threshold</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-18-33" name="__codelineno-18-33"></a>
<a id="__codelineno-18-34" name="__codelineno-18-34"></a>        <span class="c1"># Keeping only the indices that fit within the threshold</span>
<a id="__codelineno-18-35" name="__codelineno-18-35"></a>        <span class="n">sorted_indices</span> <span class="o">=</span> <span class="n">sorted_indices</span><span class="p">[</span><span class="n">keep_indices</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-18-36" name="__codelineno-18-36"></a>
<a id="__codelineno-18-37" name="__codelineno-18-37"></a>    <span class="k">return</span> <span class="n">keep_boxes</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-19-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-19-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-19-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-19-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-19-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-19-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-19-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-19-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-19-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-19-10">10</a></span>
<span class="normal"><a href="#__codelineno-19-11">11</a></span>
<span class="normal"><a href="#__codelineno-19-12">12</a></span>
<span class="normal"><a href="#__codelineno-19-13">13</a></span>
<span class="normal"><a href="#__codelineno-19-14">14</a></span>
<span class="normal"><a href="#__codelineno-19-15">15</a></span>
<span class="normal"><a href="#__codelineno-19-16">16</a></span>
<span class="normal"><a href="#__codelineno-19-17">17</a></span>
<span class="normal"><a href="#__codelineno-19-18">18</a></span>
<span class="normal"><a href="#__codelineno-19-19">19</a></span>
<span class="normal"><a href="#__codelineno-19-20">20</a></span>
<span class="normal"><a href="#__codelineno-19-21">21</a></span>
<span class="normal"><a href="#__codelineno-19-22">22</a></span>
<span class="normal"><a href="#__codelineno-19-23">23</a></span>
<span class="normal"><a href="#__codelineno-19-24">24</a></span>
<span class="normal"><a href="#__codelineno-19-25">25</a></span>
<span class="normal"><a href="#__codelineno-19-26">26</a></span>
<span class="normal"><a href="#__codelineno-19-27">27</a></span>
<span class="normal"><a href="#__codelineno-19-28">28</a></span>
<span class="normal"><a href="#__codelineno-19-29">29</a></span>
<span class="normal"><a href="#__codelineno-19-30">30</a></span>
<span class="normal"><a href="#__codelineno-19-31">31</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="c1"># Computing the Intersection over the Union of the bounding box.</span>
<a id="__codelineno-19-2" name="__codelineno-19-2"></a><span class="k">def</span> <span class="nf">compute_iou</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">boxes</span><span class="p">):</span>
<a id="__codelineno-19-3" name="__codelineno-19-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-19-4" name="__codelineno-19-4"></a><span class="sd">    This function helps in calculating the intersection over union of the bounding boxes.</span>
<a id="__codelineno-19-5" name="__codelineno-19-5"></a><span class="sd">    This function best works with prediction result, where one predicted box is computed with </span>
<a id="__codelineno-19-6" name="__codelineno-19-6"></a><span class="sd">    multiple different predicted boxes.</span>
<a id="__codelineno-19-7" name="__codelineno-19-7"></a>
<a id="__codelineno-19-8" name="__codelineno-19-8"></a><span class="sd">    Parameters:</span>
<a id="__codelineno-19-9" name="__codelineno-19-9"></a><span class="sd">        box: An array containing values of a bounding box.</span>
<a id="__codelineno-19-10" name="__codelineno-19-10"></a><span class="sd">        boxes: An array containing values of multiple different bounding box.</span>
<a id="__codelineno-19-11" name="__codelineno-19-11"></a>
<a id="__codelineno-19-12" name="__codelineno-19-12"></a><span class="sd">    Returns:</span>
<a id="__codelineno-19-13" name="__codelineno-19-13"></a><span class="sd">        iou: An array containing iou values in between range (0, 1) for all the boxes array.</span>
<a id="__codelineno-19-14" name="__codelineno-19-14"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-19-15" name="__codelineno-19-15"></a>    <span class="c1"># Getting the intersection box</span>
<a id="__codelineno-19-16" name="__codelineno-19-16"></a>    <span class="n">xmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-19-17" name="__codelineno-19-17"></a>    <span class="n">ymin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-19-18" name="__codelineno-19-18"></a>    <span class="n">xmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span>
<a id="__codelineno-19-19" name="__codelineno-19-19"></a>    <span class="n">ymax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">])</span>
<a id="__codelineno-19-20" name="__codelineno-19-20"></a>
<a id="__codelineno-19-21" name="__codelineno-19-21"></a>    <span class="c1"># Compute intersection area</span>
<a id="__codelineno-19-22" name="__codelineno-19-22"></a>    <span class="n">intersection_area</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">)</span>
<a id="__codelineno-19-23" name="__codelineno-19-23"></a>
<a id="__codelineno-19-24" name="__codelineno-19-24"></a>    <span class="c1"># Compute union area</span>
<a id="__codelineno-19-25" name="__codelineno-19-25"></a>    <span class="n">box_area</span> <span class="o">=</span> <span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-19-26" name="__codelineno-19-26"></a>    <span class="n">boxes_area</span> <span class="o">=</span> <span class="p">(</span><span class="n">boxes</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">boxes</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-19-27" name="__codelineno-19-27"></a>    <span class="n">union_area</span> <span class="o">=</span> <span class="n">box_area</span> <span class="o">+</span> <span class="n">boxes_area</span> <span class="o">-</span> <span class="n">intersection_area</span>
<a id="__codelineno-19-28" name="__codelineno-19-28"></a>
<a id="__codelineno-19-29" name="__codelineno-19-29"></a>    <span class="c1"># Compute IoU</span>
<a id="__codelineno-19-30" name="__codelineno-19-30"></a>    <span class="n">iou</span> <span class="o">=</span> <span class="n">intersection_area</span> <span class="o">/</span> <span class="n">union_area</span>
<a id="__codelineno-19-31" name="__codelineno-19-31"></a>    <span class="k">return</span> <span class="n">iou</span>
</code></pre></div></td></tr></table></div>
</div>
</div>
</div>
<p>Now, with this, we have the bounding box, let's move to the next stage which is to extract the mask. The process to extract needs to be in a sequential method similar to the way I extracted the bounding box.</p>
<ol>
<li>
<p>First I take the mask prediction that we got along with the boxes while extracting the boxes. This mask prediction is determined by the highest confidence score and performs a matrix multiplication with the second output of the inference result. Next, the result is processed using the sigmoid method and reshaped to the mask images i.e. [1, 128, 128]</p>
</li>
<li>
<p>A copy of the bounding box is rescaled to the shape of the mask image. </p>
</li>
<li>
<p>Next, an image tensor of the same shape as the input image is been created containing only black pixels. </p>
<ul>
<li>First, the scaled mask copy is cropped to the bounding box size, this gives us a clear shape of the masking tensor. </li>
<li>After that, the cropped mask is resized to the shape of the original bounding box, and all the values in the mask are given a threshold of 0.5, which makes it either a 0 or 1 value mask. </li>
</ul>
</li>
<li>
<p>This mask is then replaced with the mask area of the initially created black pixel image tensor.</p>
</li>
</ol>
<div class="tabbed-set tabbed-alternate" data-tabs="3:2"><input checked="checked" id="__tabbed_3_1" name="__tabbed_3" type="radio" /><input id="__tabbed_3_2" name="__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="__tabbed_3_1">engine.py</label><label for="__tabbed_3_2">sigmoid</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-20-124">124</a></span>
<span class="normal"><a href="#__codelineno-20-125">125</a></span>
<span class="normal"><a href="#__codelineno-20-126">126</a></span>
<span class="normal"><a href="#__codelineno-20-127">127</a></span>
<span class="normal"><a href="#__codelineno-20-128">128</a></span>
<span class="normal"><a href="#__codelineno-20-129">129</a></span>
<span class="normal"><a href="#__codelineno-20-130">130</a></span>
<span class="normal"><a href="#__codelineno-20-131">131</a></span>
<span class="normal"><a href="#__codelineno-20-132">132</a></span>
<span class="normal"><a href="#__codelineno-20-133">133</a></span>
<span class="normal"><a href="#__codelineno-20-134">134</a></span>
<span class="normal"><a href="#__codelineno-20-135">135</a></span>
<span class="normal"><a href="#__codelineno-20-136">136</a></span>
<span class="normal"><a href="#__codelineno-20-137">137</a></span>
<span class="normal"><a href="#__codelineno-20-138">138</a></span>
<span class="normal"><a href="#__codelineno-20-139">139</a></span>
<span class="normal"><a href="#__codelineno-20-140">140</a></span>
<span class="normal"><a href="#__codelineno-20-141">141</a></span>
<span class="normal"><a href="#__codelineno-20-142">142</a></span>
<span class="normal"><a href="#__codelineno-20-143">143</a></span>
<span class="normal"><a href="#__codelineno-20-144">144</a></span>
<span class="normal"><a href="#__codelineno-20-145">145</a></span>
<span class="normal"><a href="#__codelineno-20-146">146</a></span>
<span class="normal"><a href="#__codelineno-20-147">147</a></span>
<span class="normal"><a href="#__codelineno-20-148">148</a></span>
<span class="normal"><a href="#__codelineno-20-149">149</a></span>
<span class="normal"><a href="#__codelineno-20-150">150</a></span>
<span class="normal"><a href="#__codelineno-20-151">151</a></span>
<span class="normal"><a href="#__codelineno-20-152">152</a></span>
<span class="normal"><a href="#__codelineno-20-153">153</a></span>
<span class="normal"><a href="#__codelineno-20-154">154</a></span>
<span class="normal"><a href="#__codelineno-20-155">155</a></span>
<span class="normal"><a href="#__codelineno-20-156">156</a></span>
<span class="normal"><a href="#__codelineno-20-157">157</a></span>
<span class="normal"><a href="#__codelineno-20-158">158</a></span>
<span class="normal"><a href="#__codelineno-20-159">159</a></span>
<span class="normal"><a href="#__codelineno-20-160">160</a></span>
<span class="normal"><a href="#__codelineno-20-161">161</a></span>
<span class="normal"><a href="#__codelineno-20-162">162</a></span>
<span class="normal"><a href="#__codelineno-20-163">163</a></span>
<span class="normal"><a href="#__codelineno-20-164">164</a></span>
<span class="normal"><a href="#__codelineno-20-165">165</a></span>
<span class="normal"><a href="#__codelineno-20-166">166</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-20-124" name="__codelineno-20-124"></a><span class="k">def</span> <span class="nf">process_mask_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask_predictions</span><span class="p">,</span> <span class="n">mask_output</span><span class="p">):</span>
<a id="__codelineno-20-125" name="__codelineno-20-125"></a>    <span class="c1"># If no mask prediction</span>
<a id="__codelineno-20-126" name="__codelineno-20-126"></a>    <span class="k">if</span> <span class="n">mask_predictions</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-20-127" name="__codelineno-20-127"></a>        <span class="k">return</span> <span class="p">[]</span>
<a id="__codelineno-20-128" name="__codelineno-20-128"></a>
<a id="__codelineno-20-129" name="__codelineno-20-129"></a>    <span class="n">mask_output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">mask_output</span><span class="p">)</span>
<a id="__codelineno-20-130" name="__codelineno-20-130"></a>
<a id="__codelineno-20-131" name="__codelineno-20-131"></a>    <span class="c1"># Calculate the mask area for all the box</span>
<a id="__codelineno-20-132" name="__codelineno-20-132"></a><span class="hll">    <span class="n">num_mask</span><span class="p">,</span> <span class="n">mask_height</span><span class="p">,</span> <span class="n">mask_width</span> <span class="o">=</span> <span class="n">mask_output</span><span class="o">.</span><span class="n">shape</span>
</span><a id="__codelineno-20-133" name="__codelineno-20-133"></a><span class="hll">    <span class="n">masks</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">mask_predictions</span> <span class="o">@</span> <span class="n">mask_output</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">num_mask</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
</span><a id="__codelineno-20-134" name="__codelineno-20-134"></a><span class="hll">    <span class="n">masks</span> <span class="o">=</span> <span class="n">masks</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">mask_height</span><span class="p">,</span> <span class="n">mask_width</span><span class="p">))</span>
</span><a id="__codelineno-20-135" name="__codelineno-20-135"></a>
<a id="__codelineno-20-136" name="__codelineno-20-136"></a>    <span class="c1"># Rescale the boxes to match the mask size</span>
<a id="__codelineno-20-137" name="__codelineno-20-137"></a><span class="hll">    <span class="n">scale_boxes</span> <span class="o">=</span> <span class="n">rescale_boxes</span><span class="p">(</span><span class="n">boxes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">boxes</span><span class="p">,</span>
</span><a id="__codelineno-20-138" name="__codelineno-20-138"></a><span class="hll">                                <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_height</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_width</span><span class="p">),</span>
</span><a id="__codelineno-20-139" name="__codelineno-20-139"></a><span class="hll">                                <span class="n">output_shape</span><span class="o">=</span><span class="p">(</span><span class="n">mask_height</span><span class="p">,</span> <span class="n">mask_width</span><span class="p">))</span>
</span><a id="__codelineno-20-140" name="__codelineno-20-140"></a>
<a id="__codelineno-20-141" name="__codelineno-20-141"></a>    <span class="c1"># Mask map for each box and mask pair</span>
<a id="__codelineno-20-142" name="__codelineno-20-142"></a><span class="hll">    <span class="n">mask_maps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">scale_boxes</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_height</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_width</span><span class="p">))</span>
</span><a id="__codelineno-20-143" name="__codelineno-20-143"></a>    <span class="n">blur_size</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_width</span><span class="o">/</span><span class="n">mask_width</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_height</span><span class="o">/</span><span class="n">mask_height</span><span class="p">))</span>
<a id="__codelineno-20-144" name="__codelineno-20-144"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">scale_boxes</span><span class="p">)):</span>
<a id="__codelineno-20-145" name="__codelineno-20-145"></a>        <span class="c1"># Rounding the scaled boxes</span>
<a id="__codelineno-20-146" name="__codelineno-20-146"></a>        <span class="n">scale_x1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">scale_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
<a id="__codelineno-20-147" name="__codelineno-20-147"></a>        <span class="n">scale_y1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">scale_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
<a id="__codelineno-20-148" name="__codelineno-20-148"></a>        <span class="n">scale_x2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">scale_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span>
<a id="__codelineno-20-149" name="__codelineno-20-149"></a>        <span class="n">scale_y2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">scale_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]))</span>
<a id="__codelineno-20-150" name="__codelineno-20-150"></a>
<a id="__codelineno-20-151" name="__codelineno-20-151"></a>        <span class="c1"># Rounding the base boxes</span>
<a id="__codelineno-20-152" name="__codelineno-20-152"></a>        <span class="n">x1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
<a id="__codelineno-20-153" name="__codelineno-20-153"></a>        <span class="n">y1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
<a id="__codelineno-20-154" name="__codelineno-20-154"></a>        <span class="n">x2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span>
<a id="__codelineno-20-155" name="__codelineno-20-155"></a>        <span class="n">y2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]))</span>
<a id="__codelineno-20-156" name="__codelineno-20-156"></a>
<a id="__codelineno-20-157" name="__codelineno-20-157"></a>        <span class="c1"># Cropping the scaled mask and resizing it to the image dimension</span>
<a id="__codelineno-20-158" name="__codelineno-20-158"></a><span class="hll">        <span class="n">scale_crop_mask</span> <span class="o">=</span> <span class="n">masks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">scale_y1</span><span class="p">:</span> <span class="n">scale_y2</span><span class="p">,</span> <span class="n">scale_x1</span><span class="p">:</span> <span class="n">scale_x2</span><span class="p">]</span>
</span><a id="__codelineno-20-159" name="__codelineno-20-159"></a><span class="hll">        <span class="n">crop_mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">scale_crop_mask</span><span class="p">,</span> 
</span><a id="__codelineno-20-160" name="__codelineno-20-160"></a><span class="hll">                               <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span><span class="p">),</span> 
</span><a id="__codelineno-20-161" name="__codelineno-20-161"></a><span class="hll">                               <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_CUBIC</span><span class="p">)</span>
</span><a id="__codelineno-20-162" name="__codelineno-20-162"></a><span class="hll">        <span class="n">crop_mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">blur</span><span class="p">(</span><span class="n">crop_mask</span><span class="p">,</span> <span class="n">blur_size</span><span class="p">)</span>
</span><a id="__codelineno-20-163" name="__codelineno-20-163"></a><span class="hll">        <span class="n">crop_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">crop_mask</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</span><a id="__codelineno-20-164" name="__codelineno-20-164"></a><span class="hll">        <span class="n">mask_maps</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">y1</span><span class="p">:</span><span class="n">y2</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span><span class="n">x2</span><span class="p">]</span> <span class="o">=</span> <span class="n">crop_mask</span>
</span><a id="__codelineno-20-165" name="__codelineno-20-165"></a>
<a id="__codelineno-20-166" name="__codelineno-20-166"></a>    <span class="k">return</span> <span class="n">mask_maps</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="c1"># Compute sigmoid</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="k">def</span> <span class="nf">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="sd">    This function computes the mathematical sigmoid function.</span>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="sd">    Parameters: x: An int or array.</span>
<a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="sd">    Returns: An int or array containing values after computing.</span>
<a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a>    <span class="k">return</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">))</span>
</code></pre></div>
</div>
</div>
</div>
<p>Now that, we have all the predictions, both the bounding box and the mask it's time to visualize the prediction. There are a total of two predictions so we can either visualize one or both. To simplify these two different functions are used one to draw the mask other to draw the box. If the mask is missing then the box will fill the box area with a color.</p>
<ul>
<li>
<p>Drawing a mask is simple unlike before when I used <code>cv2.drawContours</code>, this time we can crop the mask tensor and the image tensor using the bounding box area and replacing the mask area with the color. Then using the <code>cv2.addWeighted</code> I can change the opacity of the color and place both images one above the other.</p>
</li>
<li>
<p>After drawing the mask, I use the mask image and draw the bounding box using the <code>cv2.rectangle</code> and write a text of the detect class using the <code>cv2.putText</code>.</p>
</li>
</ul>
<div class="tabbed-set tabbed-alternate" data-tabs="4:3"><input checked="checked" id="__tabbed_4_1" name="__tabbed_4" type="radio" /><input id="__tabbed_4_2" name="__tabbed_4" type="radio" /><input id="__tabbed_4_3" name="__tabbed_4" type="radio" /><div class="tabbed-labels"><label for="__tabbed_4_1">engine.py</label><label for="__tabbed_4_2">draw_mask</label><label for="__tabbed_4_3">draw_detection</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-22-168">168</a></span>
<span class="normal"><a href="#__codelineno-22-169">169</a></span>
<span class="normal"><a href="#__codelineno-22-170">170</a></span>
<span class="normal"><a href="#__codelineno-22-171">171</a></span>
<span class="normal"><a href="#__codelineno-22-172">172</a></span>
<span class="normal"><a href="#__codelineno-22-173">173</a></span>
<span class="normal"><a href="#__codelineno-22-174">174</a></span>
<span class="normal"><a href="#__codelineno-22-175">175</a></span>
<span class="normal"><a href="#__codelineno-22-176">176</a></span>
<span class="normal"><a href="#__codelineno-22-177">177</a></span>
<span class="normal"><a href="#__codelineno-22-178">178</a></span>
<span class="normal"><a href="#__codelineno-22-179">179</a></span>
<span class="normal"><a href="#__codelineno-22-180">180</a></span>
<span class="normal"><a href="#__codelineno-22-181">181</a></span>
<span class="normal"><a href="#__codelineno-22-182">182</a></span>
<span class="normal"><a href="#__codelineno-22-183">183</a></span>
<span class="normal"><a href="#__codelineno-22-184">184</a></span>
<span class="normal"><a href="#__codelineno-22-185">185</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-22-168" name="__codelineno-22-168"></a><span class="k">def</span> <span class="nf">draw_bbox</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">mask_alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
<a id="__codelineno-22-169" name="__codelineno-22-169"></a>    <span class="c1"># Drawing only the bounding box and filling it.</span>
<a id="__codelineno-22-170" name="__codelineno-22-170"></a>    <span class="k">return</span> <span class="n">draw_detections</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">image</span><span class="p">,</span>
<a id="__codelineno-22-171" name="__codelineno-22-171"></a>                           <span class="n">boxes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">boxes</span><span class="p">,</span>
<a id="__codelineno-22-172" name="__codelineno-22-172"></a>                           <span class="n">scores</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">,</span>
<a id="__codelineno-22-173" name="__codelineno-22-173"></a>                           <span class="n">class_ids</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">class_ids</span><span class="p">,</span>
<a id="__codelineno-22-174" name="__codelineno-22-174"></a>                           <span class="n">class_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">class_list</span><span class="p">,</span>
<a id="__codelineno-22-175" name="__codelineno-22-175"></a>                           <span class="n">mask_alpha</span><span class="o">=</span><span class="n">mask_alpha</span><span class="p">)</span>
<a id="__codelineno-22-176" name="__codelineno-22-176"></a>
<a id="__codelineno-22-177" name="__codelineno-22-177"></a><span class="k">def</span> <span class="nf">draw_masks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">mask_alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
<a id="__codelineno-22-178" name="__codelineno-22-178"></a>    <span class="c1"># Drawing both the bounding box and the mask</span>
<a id="__codelineno-22-179" name="__codelineno-22-179"></a>    <span class="k">return</span> <span class="n">draw_detections</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">image</span><span class="p">,</span>
<a id="__codelineno-22-180" name="__codelineno-22-180"></a>                           <span class="n">boxes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">boxes</span><span class="p">,</span>
<a id="__codelineno-22-181" name="__codelineno-22-181"></a>                           <span class="n">scores</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scores</span><span class="p">,</span>
<a id="__codelineno-22-182" name="__codelineno-22-182"></a>                           <span class="n">class_ids</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">class_ids</span><span class="p">,</span>
<a id="__codelineno-22-183" name="__codelineno-22-183"></a>                           <span class="n">class_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">class_list</span><span class="p">,</span>
<a id="__codelineno-22-184" name="__codelineno-22-184"></a>                           <span class="n">mask_alpha</span><span class="o">=</span><span class="n">mask_alpha</span><span class="p">,</span>
<a id="__codelineno-22-185" name="__codelineno-22-185"></a>                           <span class="n">mask_maps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mask_maps</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-23-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-23-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-23-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-23-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-23-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-23-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-23-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-23-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-23-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-23-10">10</a></span>
<span class="normal"><a href="#__codelineno-23-11">11</a></span>
<span class="normal"><a href="#__codelineno-23-12">12</a></span>
<span class="normal"><a href="#__codelineno-23-13">13</a></span>
<span class="normal"><a href="#__codelineno-23-14">14</a></span>
<span class="normal"><a href="#__codelineno-23-15">15</a></span>
<span class="normal"><a href="#__codelineno-23-16">16</a></span>
<span class="normal"><a href="#__codelineno-23-17">17</a></span>
<span class="normal"><a href="#__codelineno-23-18">18</a></span>
<span class="normal"><a href="#__codelineno-23-19">19</a></span>
<span class="normal"><a href="#__codelineno-23-20">20</a></span>
<span class="normal"><a href="#__codelineno-23-21">21</a></span>
<span class="normal"><a href="#__codelineno-23-22">22</a></span>
<span class="normal"><a href="#__codelineno-23-23">23</a></span>
<span class="normal"><a href="#__codelineno-23-24">24</a></span>
<span class="normal"><a href="#__codelineno-23-25">25</a></span>
<span class="normal"><a href="#__codelineno-23-26">26</a></span>
<span class="normal"><a href="#__codelineno-23-27">27</a></span>
<span class="normal"><a href="#__codelineno-23-28">28</a></span>
<span class="normal"><a href="#__codelineno-23-29">29</a></span>
<span class="normal"><a href="#__codelineno-23-30">30</a></span>
<span class="normal"><a href="#__codelineno-23-31">31</a></span>
<span class="normal"><a href="#__codelineno-23-32">32</a></span>
<span class="normal"><a href="#__codelineno-23-33">33</a></span>
<span class="normal"><a href="#__codelineno-23-34">34</a></span>
<span class="normal"><a href="#__codelineno-23-35">35</a></span>
<span class="normal"><a href="#__codelineno-23-36">36</a></span>
<span class="normal"><a href="#__codelineno-23-37">37</a></span>
<span class="normal"><a href="#__codelineno-23-38">38</a></span>
<span class="normal"><a href="#__codelineno-23-39">39</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1"></a><span class="c1"># Drawing the mask prediction on the image or frame</span>
<a id="__codelineno-23-2" name="__codelineno-23-2"></a><span class="k">def</span> <span class="nf">draw_masks</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">boxes</span><span class="p">,</span> <span class="n">class_ids</span><span class="p">,</span> <span class="n">class_list</span><span class="p">,</span> <span class="n">mask_alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">mask_maps</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-23-3" name="__codelineno-23-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-23-4" name="__codelineno-23-4"></a><span class="sd">    This function draws the predicted mask on the base image.</span>
<a id="__codelineno-23-5" name="__codelineno-23-5"></a>
<a id="__codelineno-23-6" name="__codelineno-23-6"></a><span class="sd">    Parameters:</span>
<a id="__codelineno-23-7" name="__codelineno-23-7"></a><span class="sd">        image: An array containing the values of the base image in RGB format.</span>
<a id="__codelineno-23-8" name="__codelineno-23-8"></a><span class="sd">        boxes: An array containing the values of the predicted bounding box in Pascal Voc format. </span>
<a id="__codelineno-23-9" name="__codelineno-23-9"></a><span class="sd">        class_ids: An array containing the values of the predicted classes indices. </span>
<a id="__codelineno-23-10" name="__codelineno-23-10"></a><span class="sd">        class_list: A list containing all the class names in proper order. </span>
<a id="__codelineno-23-11" name="__codelineno-23-11"></a><span class="sd">        mask_alpha: Default = 0.5, A float in range (0, 1) for opacity of the mask area. </span>
<a id="__codelineno-23-12" name="__codelineno-23-12"></a><span class="sd">        mask_maps: Default = None, An array containing the values of the mask area.</span>
<a id="__codelineno-23-13" name="__codelineno-23-13"></a>
<a id="__codelineno-23-14" name="__codelineno-23-14"></a><span class="sd">    Returns:</span>
<a id="__codelineno-23-15" name="__codelineno-23-15"></a><span class="sd">        (masked_image, colors): A tuple containing the masked image array and colors list used for the classes.</span>
<a id="__codelineno-23-16" name="__codelineno-23-16"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-23-17" name="__codelineno-23-17"></a>    <span class="n">mask_image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-23-18" name="__codelineno-23-18"></a>
<a id="__codelineno-23-19" name="__codelineno-23-19"></a>    <span class="c1"># Generating colors for every class</span>
<a id="__codelineno-23-20" name="__codelineno-23-20"></a>    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a id="__codelineno-23-21" name="__codelineno-23-21"></a>    <span class="n">colors</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">class_list</span><span class="p">),</span> <span class="mi">3</span><span class="p">))</span>
<a id="__codelineno-23-22" name="__codelineno-23-22"></a>
<a id="__codelineno-23-23" name="__codelineno-23-23"></a>    <span class="c1"># Drawing predicted objects</span>
<a id="__codelineno-23-24" name="__codelineno-23-24"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">class_id</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">class_ids</span><span class="p">)):</span>
<a id="__codelineno-23-25" name="__codelineno-23-25"></a>        <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">class_id</span><span class="p">]</span>
<a id="__codelineno-23-26" name="__codelineno-23-26"></a>        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<a id="__codelineno-23-27" name="__codelineno-23-27"></a>
<a id="__codelineno-23-28" name="__codelineno-23-28"></a>        <span class="c1"># Fill bounding box on condition</span>
<a id="__codelineno-23-29" name="__codelineno-23-29"></a>        <span class="k">if</span> <span class="n">mask_maps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-23-30" name="__codelineno-23-30"></a><span class="hll">            <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">mask_image</span><span class="p">,</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">),</span> <span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">),</span> <span class="n">color</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><a id="__codelineno-23-31" name="__codelineno-23-31"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-23-32" name="__codelineno-23-32"></a>            <span class="c1"># Fill mask on condition</span>
<a id="__codelineno-23-33" name="__codelineno-23-33"></a><span class="hll">            <span class="n">crop_mask</span> <span class="o">=</span> <span class="n">mask_maps</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">y1</span><span class="p">:</span><span class="n">y2</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span><span class="n">x2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="c1"># Cropping the mask area</span>
</span><a id="__codelineno-23-34" name="__codelineno-23-34"></a><span class="hll">            <span class="n">crop_mask_image</span> <span class="o">=</span> <span class="n">mask_image</span><span class="p">[</span><span class="n">y1</span><span class="p">:</span><span class="n">y2</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span><span class="n">x2</span><span class="p">]</span> <span class="c1"># Cropping the mask area from the image</span>
</span><a id="__codelineno-23-35" name="__codelineno-23-35"></a><span class="hll">            <span class="n">crop_mask_image</span> <span class="o">=</span> <span class="n">crop_mask_image</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">crop_mask</span><span class="p">)</span> <span class="o">+</span> <span class="n">crop_mask</span> <span class="o">*</span> <span class="n">color</span> <span class="c1"># Adding color to the mask area</span>
</span><a id="__codelineno-23-36" name="__codelineno-23-36"></a><span class="hll">            <span class="n">mask_image</span><span class="p">[</span><span class="n">y1</span><span class="p">:</span><span class="n">y2</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span><span class="n">x2</span><span class="p">]</span> <span class="o">=</span> <span class="n">crop_mask_image</span> <span class="c1"># Replacing the mask area in the image</span>
</span><a id="__codelineno-23-37" name="__codelineno-23-37"></a>
<a id="__codelineno-23-38" name="__codelineno-23-38"></a>    <span class="c1"># Returning mask image with color opacity</span>
<a id="__codelineno-23-39" name="__codelineno-23-39"></a><span class="hll">    <span class="k">return</span> <span class="n">cv2</span><span class="o">.</span><span class="n">addWeighted</span><span class="p">(</span><span class="n">mask_image</span><span class="p">,</span> <span class="n">mask_alpha</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">mask_alpha</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">colors</span>
</span></code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-24-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-24-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-24-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-24-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-24-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-24-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-24-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-24-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-24-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-24-10">10</a></span>
<span class="normal"><a href="#__codelineno-24-11">11</a></span>
<span class="normal"><a href="#__codelineno-24-12">12</a></span>
<span class="normal"><a href="#__codelineno-24-13">13</a></span>
<span class="normal"><a href="#__codelineno-24-14">14</a></span>
<span class="normal"><a href="#__codelineno-24-15">15</a></span>
<span class="normal"><a href="#__codelineno-24-16">16</a></span>
<span class="normal"><a href="#__codelineno-24-17">17</a></span>
<span class="normal"><a href="#__codelineno-24-18">18</a></span>
<span class="normal"><a href="#__codelineno-24-19">19</a></span>
<span class="normal"><a href="#__codelineno-24-20">20</a></span>
<span class="normal"><a href="#__codelineno-24-21">21</a></span>
<span class="normal"><a href="#__codelineno-24-22">22</a></span>
<span class="normal"><a href="#__codelineno-24-23">23</a></span>
<span class="normal"><a href="#__codelineno-24-24">24</a></span>
<span class="normal"><a href="#__codelineno-24-25">25</a></span>
<span class="normal"><a href="#__codelineno-24-26">26</a></span>
<span class="normal"><a href="#__codelineno-24-27">27</a></span>
<span class="normal"><a href="#__codelineno-24-28">28</a></span>
<span class="normal"><a href="#__codelineno-24-29">29</a></span>
<span class="normal"><a href="#__codelineno-24-30">30</a></span>
<span class="normal"><a href="#__codelineno-24-31">31</a></span>
<span class="normal"><a href="#__codelineno-24-32">32</a></span>
<span class="normal"><a href="#__codelineno-24-33">33</a></span>
<span class="normal"><a href="#__codelineno-24-34">34</a></span>
<span class="normal"><a href="#__codelineno-24-35">35</a></span>
<span class="normal"><a href="#__codelineno-24-36">36</a></span>
<span class="normal"><a href="#__codelineno-24-37">37</a></span>
<span class="normal"><a href="#__codelineno-24-38">38</a></span>
<span class="normal"><a href="#__codelineno-24-39">39</a></span>
<span class="normal"><a href="#__codelineno-24-40">40</a></span>
<span class="normal"><a href="#__codelineno-24-41">41</a></span>
<span class="normal"><a href="#__codelineno-24-42">42</a></span>
<span class="normal"><a href="#__codelineno-24-43">43</a></span>
<span class="normal"><a href="#__codelineno-24-44">44</a></span>
<span class="normal"><a href="#__codelineno-24-45">45</a></span>
<span class="normal"><a href="#__codelineno-24-46">46</a></span>
<span class="normal"><a href="#__codelineno-24-47">47</a></span>
<span class="normal"><a href="#__codelineno-24-48">48</a></span>
<span class="normal"><a href="#__codelineno-24-49">49</a></span>
<span class="normal"><a href="#__codelineno-24-50">50</a></span>
<span class="normal"><a href="#__codelineno-24-51">51</a></span>
<span class="normal"><a href="#__codelineno-24-52">52</a></span>
<span class="normal"><a href="#__codelineno-24-53">53</a></span>
<span class="normal"><a href="#__codelineno-24-54">54</a></span>
<span class="normal"><a href="#__codelineno-24-55">55</a></span>
<span class="normal"><a href="#__codelineno-24-56">56</a></span>
<span class="normal"><a href="#__codelineno-24-57">57</a></span>
<span class="normal"><a href="#__codelineno-24-58">58</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1"></a><span class="c1"># Drawing the bounding box and adding label text on the predicted image mask</span>
<a id="__codelineno-24-2" name="__codelineno-24-2"></a><span class="k">def</span> <span class="nf">draw_detections</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">boxes</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">class_ids</span><span class="p">,</span> <span class="n">class_list</span><span class="p">,</span> <span class="n">mask_alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">mask_maps</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-24-3" name="__codelineno-24-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-24-4" name="__codelineno-24-4"></a><span class="sd">    This function helps in drawing the predicted detection bounding box and mask.</span>
<a id="__codelineno-24-5" name="__codelineno-24-5"></a>
<a id="__codelineno-24-6" name="__codelineno-24-6"></a><span class="sd">    Parameters:</span>
<a id="__codelineno-24-7" name="__codelineno-24-7"></a><span class="sd">        image: An array containing the values of the base image in RGB format.</span>
<a id="__codelineno-24-8" name="__codelineno-24-8"></a><span class="sd">        boxes: An array containing the values of the predicted bounding box in Pascal Voc format.</span>
<a id="__codelineno-24-9" name="__codelineno-24-9"></a><span class="sd">        scores: An array containing the values of the confidence score for each predicted bounding box.</span>
<a id="__codelineno-24-10" name="__codelineno-24-10"></a><span class="sd">        class_ids: An array containing the values of the predicted classes indices. </span>
<a id="__codelineno-24-11" name="__codelineno-24-11"></a><span class="sd">        class_list: A list containing all the class names in proper order. </span>
<a id="__codelineno-24-12" name="__codelineno-24-12"></a><span class="sd">        mask_alpha: Default = 0.5, A float in range (0, 1) for opacity of the mask area. </span>
<a id="__codelineno-24-13" name="__codelineno-24-13"></a><span class="sd">        mask_maps: Default = None, An array containing the values of the mask area.</span>
<a id="__codelineno-24-14" name="__codelineno-24-14"></a>
<a id="__codelineno-24-15" name="__codelineno-24-15"></a><span class="sd">    Returns:</span>
<a id="__codelineno-24-16" name="__codelineno-24-16"></a><span class="sd">        mask_image: An array containing the values for image with objects predicted.</span>
<a id="__codelineno-24-17" name="__codelineno-24-17"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-24-18" name="__codelineno-24-18"></a>    <span class="n">image_height</span><span class="p">,</span> <span class="n">image_width</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
<a id="__codelineno-24-19" name="__codelineno-24-19"></a>    <span class="n">size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">image_height</span><span class="p">,</span> <span class="n">image_width</span><span class="p">])</span> <span class="o">*</span> <span class="mf">0.001</span> <span class="c1"># Dynamic fontscale</span>
<a id="__codelineno-24-20" name="__codelineno-24-20"></a>    <span class="n">text_thickness</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">([</span><span class="n">image_height</span><span class="p">,</span> <span class="n">image_width</span><span class="p">])</span> <span class="o">*</span> <span class="mf">0.001</span><span class="p">)</span> <span class="c1"># Dynamic thickness</span>
<a id="__codelineno-24-21" name="__codelineno-24-21"></a>
<a id="__codelineno-24-22" name="__codelineno-24-22"></a>    <span class="c1"># Getting the Image with mask prediction using the function</span>
<a id="__codelineno-24-23" name="__codelineno-24-23"></a><span class="hll">    <span class="n">mask_image</span><span class="p">,</span> <span class="n">colors</span> <span class="o">=</span> <span class="n">draw_masks</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">boxes</span><span class="p">,</span> <span class="n">class_ids</span><span class="p">,</span> <span class="n">class_list</span><span class="p">,</span> <span class="n">mask_alpha</span><span class="p">,</span> <span class="n">mask_maps</span><span class="p">)</span>
</span><a id="__codelineno-24-24" name="__codelineno-24-24"></a>
<a id="__codelineno-24-25" name="__codelineno-24-25"></a>    <span class="c1"># Draw predicted bounding box and labels on the mask image</span>
<a id="__codelineno-24-26" name="__codelineno-24-26"></a>    <span class="k">for</span> <span class="n">box</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">class_id</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">class_ids</span><span class="p">):</span>
<a id="__codelineno-24-27" name="__codelineno-24-27"></a>        <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">class_id</span><span class="p">]</span>
<a id="__codelineno-24-28" name="__codelineno-24-28"></a>        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<a id="__codelineno-24-29" name="__codelineno-24-29"></a>
<a id="__codelineno-24-30" name="__codelineno-24-30"></a>        <span class="c1"># Drawing rectangle</span>
<a id="__codelineno-24-31" name="__codelineno-24-31"></a>        <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">mask_image</span><span class="p">,</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">),</span> <span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">),</span> <span class="n">color</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-24-32" name="__codelineno-24-32"></a>
<a id="__codelineno-24-33" name="__codelineno-24-33"></a>        <span class="c1"># Getting the box coords of the label text</span>
<a id="__codelineno-24-34" name="__codelineno-24-34"></a>        <span class="n">label</span> <span class="o">=</span> <span class="n">class_list</span><span class="p">[</span><span class="n">class_id</span><span class="p">]</span>
<a id="__codelineno-24-35" name="__codelineno-24-35"></a>        <span class="n">caption</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">score</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s1">%&#39;</span>
<a id="__codelineno-24-36" name="__codelineno-24-36"></a><span class="hll">        <span class="p">(</span><span class="n">tw</span><span class="p">,</span> <span class="n">th</span><span class="p">),</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">getTextSize</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">caption</span><span class="p">,</span> 
</span><a id="__codelineno-24-37" name="__codelineno-24-37"></a><span class="hll">                                      <span class="n">fontFace</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_SIMPLEX</span><span class="p">,</span> 
</span><a id="__codelineno-24-38" name="__codelineno-24-38"></a><span class="hll">                                      <span class="n">fontScale</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> 
</span><a id="__codelineno-24-39" name="__codelineno-24-39"></a><span class="hll">                                      <span class="n">thickness</span><span class="o">=</span><span class="n">text_thickness</span><span class="p">)</span>
</span><a id="__codelineno-24-40" name="__codelineno-24-40"></a>        <span class="n">th</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">th</span> <span class="o">*</span> <span class="mf">1.2</span><span class="p">)</span>
<a id="__codelineno-24-41" name="__codelineno-24-41"></a>
<a id="__codelineno-24-42" name="__codelineno-24-42"></a>        <span class="c1"># Drawing rectangle for the text</span>
<a id="__codelineno-24-43" name="__codelineno-24-43"></a><span class="hll">        <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">mask_image</span><span class="p">,</span> 
</span><a id="__codelineno-24-44" name="__codelineno-24-44"></a><span class="hll">                      <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">),</span> 
</span><a id="__codelineno-24-45" name="__codelineno-24-45"></a><span class="hll">                      <span class="p">(</span><span class="n">x1</span> <span class="o">+</span> <span class="n">tw</span><span class="p">,</span> <span class="n">y1</span> <span class="o">-</span> <span class="n">th</span> <span class="k">if</span> <span class="n">y1</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">y1</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">th</span><span class="p">),</span> 
</span><a id="__codelineno-24-46" name="__codelineno-24-46"></a><span class="hll">                      <span class="n">color</span><span class="p">,</span> 
</span><a id="__codelineno-24-47" name="__codelineno-24-47"></a><span class="hll">                      <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><a id="__codelineno-24-48" name="__codelineno-24-48"></a>
<a id="__codelineno-24-49" name="__codelineno-24-49"></a>        <span class="c1"># Adding the label text</span>
<a id="__codelineno-24-50" name="__codelineno-24-50"></a><span class="hll">        <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">mask_image</span><span class="p">,</span> 
</span><a id="__codelineno-24-51" name="__codelineno-24-51"></a><span class="hll">                    <span class="n">caption</span><span class="p">,</span> 
</span><a id="__codelineno-24-52" name="__codelineno-24-52"></a><span class="hll">                    <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="k">if</span> <span class="n">y1</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">y1</span> <span class="o">+</span> <span class="mi">15</span><span class="p">),</span> 
</span><a id="__codelineno-24-53" name="__codelineno-24-53"></a><span class="hll">                    <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_SIMPLEX</span><span class="p">,</span> 
</span><a id="__codelineno-24-54" name="__codelineno-24-54"></a><span class="hll">                    <span class="n">size</span><span class="p">,</span> 
</span><a id="__codelineno-24-55" name="__codelineno-24-55"></a><span class="hll">                    <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> 
</span><a id="__codelineno-24-56" name="__codelineno-24-56"></a><span class="hll">                    <span class="n">text_thickness</span><span class="p">,</span> 
</span><a id="__codelineno-24-57" name="__codelineno-24-57"></a><span class="hll">                    <span class="n">cv2</span><span class="o">.</span><span class="n">LINE_AA</span><span class="p">)</span>
</span><a id="__codelineno-24-58" name="__codelineno-24-58"></a>    <span class="k">return</span> <span class="n">mask_image</span>
</code></pre></div></td></tr></table></div>
</div>
</div>
</div>
<p>This way we have both all the prediction data and the processed images with the result applied to them. Finally, we can conclude with the ONNX format and use it with the web app that we will be going through after this.</p>
<p>You can find the complete code for engine.py over <a href="https://github.com/JohnPPinto/food-geek-food-image-segmentation/blob/main/module/engine.py">here</a> and for utils.py over <a href="https://github.com/JohnPPinto/food-geek-food-image-segmentation/blob/main/module/utils.py">here</a></p>
<h3 id="building-api-and-web-app"><strong>Building API and Web App</strong></h3>
<p>We have everything ready at this time, now we need an API and web app that does the same work. For the API I used Fast API and for the website I used Gradio. Both of them do the work very quickly and easily, this helps in deploying the model much faster with fewer errors.</p>
<ul>
<li>
<p>Starting with the Fast API, I first initiate the FastAPI app, then I create a Post method of name predict-to-json, here the API takes the image as input using the <code>UploadFile</code> function. The uploaded image is read in bytes format which is then transformed into a Numpy array, this array is passed to the model, and all the prediction array is transformed into a JSON format and returned as a dict type. </p>
</li>
<li>
<p>Similar to the above steps a new post method is been created called predict-to-image, here the input image is taken and processed after that the predicted image is been converted into bytes format, and the buffer is read as a PNG format file to display the image.</p>
</li>
<li>
<p>Once the FastAPI app is been created, I then create the gradio app, for the gradio app there are a total of three functions:</p>
</li>
<li>
<p>gradio_predict: This function takes the input image array and gets the prediction result using the model, then the predicted mask is returned along with the classes predicted.</p>
</li>
<li>
<p>on_annot_select: This function triggers whenever the predicted class or food name is clicked, the class name is passed to the fds_food_info function in the food_info.py file, this function uses the API provided by the Food Data Center of the United States Department of Agriculture, which provided the nutritional information of the selected image and the output is shown in the textbox.</p>
</li>
<li>
<p>on_clear_btn: This function is to trigger whenever the clear button is clicked, all the content on the web app will be emptied and a new fresh app is ready to run a new image prediction.</p>
</li>
</ul>
<p>The rest of the code uses the <code>gradio.blocks</code> function to place different GUI blocks of predefined functions like the input image block <code>gradio.Image</code>, <code>gradio.Button</code>, <code>gradio.AnnotedImage</code>, <code>gradio.Examples</code> and <code>gradio.Textbox</code>. All of the information is present in the Gradio documentation.</p>
<p>Now that the web app and FastAPI are ready we can mount the web app on the FastAPI, gradio offers a direct function to do this using <code>gradio.mount_gradio_app</code>. This function mounts the gradio web app on the FastAPI app using the server provided by the FastAPI, in this case, Uvicorn is the server for the FastAPI and Gradio after mounting.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="5:3"><input checked="checked" id="__tabbed_5_1" name="__tabbed_5" type="radio" /><input id="__tabbed_5_2" name="__tabbed_5" type="radio" /><input id="__tabbed_5_3" name="__tabbed_5" type="radio" /><div class="tabbed-labels"><label for="__tabbed_5_1">app.py: FastAPI</label><label for="__tabbed_5_2">app.py: Gradio</label><label for="__tabbed_5_3">food_info.py</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-25-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-25-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-25-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-25-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-25-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-25-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-25-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-25-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-25-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-25-10">10</a></span>
<span class="normal"><a href="#__codelineno-25-11">11</a></span>
<span class="normal"><a href="#__codelineno-25-12">12</a></span>
<span class="normal"><a href="#__codelineno-25-13">13</a></span>
<span class="normal"><a href="#__codelineno-25-14">14</a></span>
<span class="normal"><a href="#__codelineno-25-15">15</a></span>
<span class="normal"><a href="#__codelineno-25-16">16</a></span>
<span class="normal"><a href="#__codelineno-25-17">17</a></span>
<span class="normal"><a href="#__codelineno-25-18">18</a></span>
<span class="normal"><a href="#__codelineno-25-19">19</a></span>
<span class="normal"><a href="#__codelineno-25-20">20</a></span>
<span class="normal"><a href="#__codelineno-25-21">21</a></span>
<span class="normal"><a href="#__codelineno-25-22">22</a></span>
<span class="normal"><a href="#__codelineno-25-23">23</a></span>
<span class="normal"><a href="#__codelineno-25-24">24</a></span>
<span class="normal"><a href="#__codelineno-25-25">25</a></span>
<span class="normal"><a href="#__codelineno-25-26">26</a></span>
<span class="normal"><a href="#__codelineno-25-27">27</a></span>
<span class="normal"><a href="#__codelineno-25-28">28</a></span>
<span class="normal"><a href="#__codelineno-25-29">29</a></span>
<span class="normal"><a href="#__codelineno-25-30">30</a></span>
<span class="normal"><a href="#__codelineno-25-31">31</a></span>
<span class="normal"><a href="#__codelineno-25-32">32</a></span>
<span class="normal"><a href="#__codelineno-25-33">33</a></span>
<span class="normal"><a href="#__codelineno-25-34">34</a></span>
<span class="normal"><a href="#__codelineno-25-35">35</a></span>
<span class="normal"><a href="#__codelineno-25-36">36</a></span>
<span class="normal"><a href="#__codelineno-25-37">37</a></span>
<span class="normal"><a href="#__codelineno-25-38">38</a></span>
<span class="normal"><a href="#__codelineno-25-39">39</a></span>
<span class="normal"><a href="#__codelineno-25-40">40</a></span>
<span class="normal"><a href="#__codelineno-25-41">41</a></span>
<span class="normal"><a href="#__codelineno-25-42">42</a></span>
<span class="normal"><a href="#__codelineno-25-43">43</a></span>
<span class="normal"><a href="#__codelineno-25-44">44</a></span>
<span class="normal"><a href="#__codelineno-25-45">45</a></span>
<span class="normal"><a href="#__codelineno-25-46">46</a></span>
<span class="normal"><a href="#__codelineno-25-47">47</a></span>
<span class="normal"><a href="#__codelineno-25-48">48</a></span>
<span class="normal"><a href="#__codelineno-25-49">49</a></span>
<span class="normal"><a href="#__codelineno-25-50">50</a></span>
<span class="normal"><a href="#__codelineno-25-51">51</a></span>
<span class="normal"><a href="#__codelineno-25-52">52</a></span>
<span class="normal"><a href="#__codelineno-25-53">53</a></span>
<span class="normal"><a href="#__codelineno-25-54">54</a></span>
<span class="normal"><a href="#__codelineno-25-55">55</a></span>
<span class="normal"><a href="#__codelineno-25-56">56</a></span>
<span class="normal"><a href="#__codelineno-25-57">57</a></span>
<span class="normal"><a href="#__codelineno-25-58">58</a></span>
<span class="normal"><a href="#__codelineno-25-59">59</a></span>
<span class="normal"><a href="#__codelineno-25-60">60</a></span>
<span class="normal"><a href="#__codelineno-25-61">61</a></span>
<span class="normal"><a href="#__codelineno-25-62">62</a></span>
<span class="normal"><a href="#__codelineno-25-63">63</a></span>
<span class="normal"><a href="#__codelineno-25-64">64</a></span>
<span class="normal"><a href="#__codelineno-25-65">65</a></span>
<span class="normal"><a href="#__codelineno-25-66">66</a></span>
<span class="normal"><a href="#__codelineno-25-67">67</a></span>
<span class="normal"><a href="#__codelineno-25-68">68</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1"></a><span class="n">model_path</span> <span class="o">=</span> <span class="s1">&#39;models/yolov8s-seg-v1.onnx&#39;</span>
<a id="__codelineno-25-2" name="__codelineno-25-2"></a>
<a id="__codelineno-25-3" name="__codelineno-25-3"></a><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Food Geek API&#39;</span><span class="p">,</span>
<a id="__codelineno-25-4" name="__codelineno-25-4"></a>              <span class="n">description</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;Upload any images of food and obtain predicted values out of the image, </span>
<a id="__codelineno-25-5" name="__codelineno-25-5"></a><span class="s1">                             return json and image result.&#39;&#39;&#39;</span><span class="p">)</span>
<a id="__codelineno-25-6" name="__codelineno-25-6"></a>
<a id="__codelineno-25-7" name="__codelineno-25-7"></a><span class="c1"># Prediction result - JSON format</span>
<a id="__codelineno-25-8" name="__codelineno-25-8"></a><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/predict-to-json&#39;</span><span class="p">)</span>
<a id="__codelineno-25-9" name="__codelineno-25-9"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">api_predict_json</span><span class="p">(</span><span class="n">file</span><span class="p">:</span> <span class="n">UploadFile</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="o">...</span><span class="p">)):</span>
<a id="__codelineno-25-10" name="__codelineno-25-10"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-25-11" name="__codelineno-25-11"></a><span class="sd">    This API will take any food image file and return a JSON file of prediction results.</span>
<a id="__codelineno-25-12" name="__codelineno-25-12"></a><span class="sd">    The prediction result will contain numpy.ndarray which is dumped into JSON format.</span>
<a id="__codelineno-25-13" name="__codelineno-25-13"></a><span class="sd">    To convert it back into the numpy.ndarray, use ```numpy.asarray(json.loads(...)) # Replace ... with the variable.  </span>
<a id="__codelineno-25-14" name="__codelineno-25-14"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-25-15" name="__codelineno-25-15"></a>    <span class="c1"># Validating only image files</span>
<a id="__codelineno-25-16" name="__codelineno-25-16"></a>    <span class="n">extension</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;jpeg&#39;</span><span class="p">,</span> <span class="s1">&#39;png&#39;</span><span class="p">)</span>
<a id="__codelineno-25-17" name="__codelineno-25-17"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">extension</span><span class="p">:</span>
<a id="__codelineno-25-18" name="__codelineno-25-18"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;File &quot;</span><span class="si">{</span><span class="n">file</span><span class="o">.</span><span class="n">filename</span><span class="si">}</span><span class="s1">&quot; must be of Image format &quot;JPG&quot;, &quot;JPEG&quot; or &quot;PNG&quot;&#39;</span>
<a id="__codelineno-25-19" name="__codelineno-25-19"></a>
<a id="__codelineno-25-20" name="__codelineno-25-20"></a>    <span class="c1"># Reading the image file</span>
<a id="__codelineno-25-21" name="__codelineno-25-21"></a>    <span class="n">content</span> <span class="o">=</span> <span class="k">await</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<a id="__codelineno-25-22" name="__codelineno-25-22"></a>    <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">content</span><span class="p">)))</span>
<a id="__codelineno-25-23" name="__codelineno-25-23"></a>
<a id="__codelineno-25-24" name="__codelineno-25-24"></a>    <span class="c1"># Getting predictions results</span>
<a id="__codelineno-25-25" name="__codelineno-25-25"></a>    <span class="n">results</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">image_array</span><span class="o">=</span><span class="n">image</span><span class="p">,</span>
<a id="__codelineno-25-26" name="__codelineno-25-26"></a>                      <span class="n">model_path</span><span class="o">=</span><span class="n">model_path</span><span class="p">,</span>
<a id="__codelineno-25-27" name="__codelineno-25-27"></a>                      <span class="n">conf_threshold</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<a id="__codelineno-25-28" name="__codelineno-25-28"></a>
<a id="__codelineno-25-29" name="__codelineno-25-29"></a>    <span class="c1"># Converting the results in json format</span>
<a id="__codelineno-25-30" name="__codelineno-25-30"></a>    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;org_image&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;org_image&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<a id="__codelineno-25-31" name="__codelineno-25-31"></a>    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;result_image&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;result_image&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<a id="__codelineno-25-32" name="__codelineno-25-32"></a>    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;boxes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;boxes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<a id="__codelineno-25-33" name="__codelineno-25-33"></a>    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;masks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;masks&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<a id="__codelineno-25-34" name="__codelineno-25-34"></a>    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;scores&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;scores&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<a id="__codelineno-25-35" name="__codelineno-25-35"></a>    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;class_ids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;class_ids&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<a id="__codelineno-25-36" name="__codelineno-25-36"></a>
<a id="__codelineno-25-37" name="__codelineno-25-37"></a>    <span class="k">return</span> <span class="n">results</span>
<a id="__codelineno-25-38" name="__codelineno-25-38"></a>
<a id="__codelineno-25-39" name="__codelineno-25-39"></a><span class="c1"># Prediction result - Image visualization</span>
<a id="__codelineno-25-40" name="__codelineno-25-40"></a><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/predict-to-image&#39;</span><span class="p">)</span>
<a id="__codelineno-25-41" name="__codelineno-25-41"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">api_predict_image</span><span class="p">(</span><span class="n">file</span><span class="p">:</span> <span class="n">UploadFile</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="o">...</span><span class="p">)):</span>
<a id="__codelineno-25-42" name="__codelineno-25-42"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-25-43" name="__codelineno-25-43"></a><span class="sd">    This API takes any image file and applies prediction on the image.</span>
<a id="__codelineno-25-44" name="__codelineno-25-44"></a><span class="sd">    Once the process is done, Resulting image with prediction will be</span>
<a id="__codelineno-25-45" name="__codelineno-25-45"></a><span class="sd">    displayed as a png file.</span>
<a id="__codelineno-25-46" name="__codelineno-25-46"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-25-47" name="__codelineno-25-47"></a>    <span class="c1"># Validating only image files</span>
<a id="__codelineno-25-48" name="__codelineno-25-48"></a>    <span class="n">extension</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;jpeg&#39;</span><span class="p">,</span> <span class="s1">&#39;png&#39;</span><span class="p">)</span>
<a id="__codelineno-25-49" name="__codelineno-25-49"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">extension</span><span class="p">:</span>
<a id="__codelineno-25-50" name="__codelineno-25-50"></a>        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;File &quot;</span><span class="si">{</span><span class="n">file</span><span class="o">.</span><span class="n">filename</span><span class="si">}</span><span class="s1">&quot; must be of Image format &quot;JPG&quot;, &quot;JPEG&quot; or &quot;PNG&quot;&#39;</span>
<a id="__codelineno-25-51" name="__codelineno-25-51"></a>
<a id="__codelineno-25-52" name="__codelineno-25-52"></a>    <span class="c1"># Reading the image file</span>
<a id="__codelineno-25-53" name="__codelineno-25-53"></a>    <span class="n">content</span> <span class="o">=</span> <span class="k">await</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<a id="__codelineno-25-54" name="__codelineno-25-54"></a>    <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">content</span><span class="p">)))</span>
<a id="__codelineno-25-55" name="__codelineno-25-55"></a>
<a id="__codelineno-25-56" name="__codelineno-25-56"></a>    <span class="c1"># Getting predictions results</span>
<a id="__codelineno-25-57" name="__codelineno-25-57"></a>    <span class="n">results</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">image_array</span><span class="o">=</span><span class="n">image</span><span class="p">,</span>
<a id="__codelineno-25-58" name="__codelineno-25-58"></a>                      <span class="n">model_path</span><span class="o">=</span><span class="n">model_path</span><span class="p">,</span>
<a id="__codelineno-25-59" name="__codelineno-25-59"></a>                      <span class="n">conf_threshold</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<a id="__codelineno-25-60" name="__codelineno-25-60"></a>
<a id="__codelineno-25-61" name="__codelineno-25-61"></a>    <span class="c1"># Converting the predicted image into PIL image</span>
<a id="__codelineno-25-62" name="__codelineno-25-62"></a>    <span class="n">img_base64</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;result_image&#39;</span><span class="p">])</span>
<a id="__codelineno-25-63" name="__codelineno-25-63"></a>
<a id="__codelineno-25-64" name="__codelineno-25-64"></a>    <span class="c1"># buffering a PNG file and returning it.</span>
<a id="__codelineno-25-65" name="__codelineno-25-65"></a>    <span class="k">with</span> <span class="n">BytesIO</span><span class="p">()</span> <span class="k">as</span> <span class="n">buf</span><span class="p">:</span>
<a id="__codelineno-25-66" name="__codelineno-25-66"></a>        <span class="n">img_base64</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;PNG&#39;</span><span class="p">)</span>
<a id="__codelineno-25-67" name="__codelineno-25-67"></a>        <span class="n">img_bytes</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
<a id="__codelineno-25-68" name="__codelineno-25-68"></a>    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">img_bytes</span><span class="p">,</span> <span class="n">media_type</span><span class="o">=</span><span class="s1">&#39;image/png&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-26-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-26-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-26-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-26-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-26-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-26-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-26-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-26-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-26-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-26-10">10</a></span>
<span class="normal"><a href="#__codelineno-26-11">11</a></span>
<span class="normal"><a href="#__codelineno-26-12">12</a></span>
<span class="normal"><a href="#__codelineno-26-13">13</a></span>
<span class="normal"><a href="#__codelineno-26-14">14</a></span>
<span class="normal"><a href="#__codelineno-26-15">15</a></span>
<span class="normal"><a href="#__codelineno-26-16">16</a></span>
<span class="normal"><a href="#__codelineno-26-17">17</a></span>
<span class="normal"><a href="#__codelineno-26-18">18</a></span>
<span class="normal"><a href="#__codelineno-26-19">19</a></span>
<span class="normal"><a href="#__codelineno-26-20">20</a></span>
<span class="normal"><a href="#__codelineno-26-21">21</a></span>
<span class="normal"><a href="#__codelineno-26-22">22</a></span>
<span class="normal"><a href="#__codelineno-26-23">23</a></span>
<span class="normal"><a href="#__codelineno-26-24">24</a></span>
<span class="normal"><a href="#__codelineno-26-25">25</a></span>
<span class="normal"><a href="#__codelineno-26-26">26</a></span>
<span class="normal"><a href="#__codelineno-26-27">27</a></span>
<span class="normal"><a href="#__codelineno-26-28">28</a></span>
<span class="normal"><a href="#__codelineno-26-29">29</a></span>
<span class="normal"><a href="#__codelineno-26-30">30</a></span>
<span class="normal"><a href="#__codelineno-26-31">31</a></span>
<span class="normal"><a href="#__codelineno-26-32">32</a></span>
<span class="normal"><a href="#__codelineno-26-33">33</a></span>
<span class="normal"><a href="#__codelineno-26-34">34</a></span>
<span class="normal"><a href="#__codelineno-26-35">35</a></span>
<span class="normal"><a href="#__codelineno-26-36">36</a></span>
<span class="normal"><a href="#__codelineno-26-37">37</a></span>
<span class="normal"><a href="#__codelineno-26-38">38</a></span>
<span class="normal"><a href="#__codelineno-26-39">39</a></span>
<span class="normal"><a href="#__codelineno-26-40">40</a></span>
<span class="normal"><a href="#__codelineno-26-41">41</a></span>
<span class="normal"><a href="#__codelineno-26-42">42</a></span>
<span class="normal"><a href="#__codelineno-26-43">43</a></span>
<span class="normal"><a href="#__codelineno-26-44">44</a></span>
<span class="normal"><a href="#__codelineno-26-45">45</a></span>
<span class="normal"><a href="#__codelineno-26-46">46</a></span>
<span class="normal"><a href="#__codelineno-26-47">47</a></span>
<span class="normal"><a href="#__codelineno-26-48">48</a></span>
<span class="normal"><a href="#__codelineno-26-49">49</a></span>
<span class="normal"><a href="#__codelineno-26-50">50</a></span>
<span class="normal"><a href="#__codelineno-26-51">51</a></span>
<span class="normal"><a href="#__codelineno-26-52">52</a></span>
<span class="normal"><a href="#__codelineno-26-53">53</a></span>
<span class="normal"><a href="#__codelineno-26-54">54</a></span>
<span class="normal"><a href="#__codelineno-26-55">55</a></span>
<span class="normal"><a href="#__codelineno-26-56">56</a></span>
<span class="normal"><a href="#__codelineno-26-57">57</a></span>
<span class="normal"><a href="#__codelineno-26-58">58</a></span>
<span class="normal"><a href="#__codelineno-26-59">59</a></span>
<span class="normal"><a href="#__codelineno-26-60">60</a></span>
<span class="normal"><a href="#__codelineno-26-61">61</a></span>
<span class="normal"><a href="#__codelineno-26-62">62</a></span>
<span class="normal"><a href="#__codelineno-26-63">63</a></span>
<span class="normal"><a href="#__codelineno-26-64">64</a></span>
<span class="normal"><a href="#__codelineno-26-65">65</a></span>
<span class="normal"><a href="#__codelineno-26-66">66</a></span>
<span class="normal"><a href="#__codelineno-26-67">67</a></span>
<span class="normal"><a href="#__codelineno-26-68">68</a></span>
<span class="normal"><a href="#__codelineno-26-69">69</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1"></a><span class="c1"># Creating a predict function for the website</span>
<a id="__codelineno-26-2" name="__codelineno-26-2"></a><span class="k">def</span> <span class="nf">gradio_predict</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>  
<a id="__codelineno-26-3" name="__codelineno-26-3"></a><span class="c1"># Getting the prediction result for the image</span>
<a id="__codelineno-26-4" name="__codelineno-26-4"></a><span class="n">results</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">image_array</span><span class="o">=</span><span class="n">img</span><span class="p">,</span>
<a id="__codelineno-26-5" name="__codelineno-26-5"></a>                  <span class="n">model_path</span><span class="o">=</span><span class="n">model_path</span><span class="p">,</span>
<a id="__codelineno-26-6" name="__codelineno-26-6"></a>                  <span class="n">conf_threshold</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<a id="__codelineno-26-7" name="__codelineno-26-7"></a>
<a id="__codelineno-26-8" name="__codelineno-26-8"></a><span class="c1"># formating the classes</span>
<a id="__codelineno-26-9" name="__codelineno-26-9"></a><span class="n">class_list</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-26-10" name="__codelineno-26-10"></a><span class="k">for</span> <span class="n">names</span> <span class="ow">in</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;classes&#39;</span><span class="p">]:</span>
<a id="__codelineno-26-11" name="__codelineno-26-11"></a>    <span class="n">class_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">names</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">))</span>
<a id="__codelineno-26-12" name="__codelineno-26-12"></a>
<a id="__codelineno-26-13" name="__codelineno-26-13"></a><span class="c1"># Validating the result</span>
<a id="__codelineno-26-14" name="__codelineno-26-14"></a><span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;masks&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-26-15" name="__codelineno-26-15"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">[([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;No Food Detected&#39;</span><span class="p">)])</span>
<a id="__codelineno-26-16" name="__codelineno-26-16"></a><span class="k">else</span><span class="p">:</span>
<a id="__codelineno-26-17" name="__codelineno-26-17"></a>    <span class="c1"># Isolating the result for every mask</span>
<a id="__codelineno-26-18" name="__codelineno-26-18"></a>    <span class="n">pred</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-26-19" name="__codelineno-26-19"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;masks&#39;</span><span class="p">])):</span>
<a id="__codelineno-26-20" name="__codelineno-26-20"></a>        <span class="n">pred</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;masks&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">class_list</span><span class="p">[</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;class_ids&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]]))</span>
<a id="__codelineno-26-21" name="__codelineno-26-21"></a>    <span class="k">return</span> <span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">pred</span><span class="p">)</span>
<a id="__codelineno-26-22" name="__codelineno-26-22"></a>
<a id="__codelineno-26-23" name="__codelineno-26-23"></a><span class="c1"># Creating a function when segment is selected</span>
<a id="__codelineno-26-24" name="__codelineno-26-24"></a><span class="k">def</span> <span class="nf">on_annot_select</span><span class="p">(</span><span class="n">evt</span><span class="p">:</span> <span class="n">gr</span><span class="o">.</span><span class="n">SelectData</span><span class="p">):</span>
<a id="__codelineno-26-25" name="__codelineno-26-25"></a>    <span class="n">info</span> <span class="o">=</span> <span class="n">fds_food_info</span><span class="p">(</span><span class="n">evt</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<a id="__codelineno-26-26" name="__codelineno-26-26"></a>    <span class="k">return</span> <span class="n">info</span>
<a id="__codelineno-26-27" name="__codelineno-26-27"></a>
<a id="__codelineno-26-28" name="__codelineno-26-28"></a><span class="c1"># Creating a function to clear all data</span>
<a id="__codelineno-26-29" name="__codelineno-26-29"></a><span class="k">def</span> <span class="nf">on_clear_btn</span><span class="p">():</span>
<a id="__codelineno-26-30" name="__codelineno-26-30"></a>    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
<a id="__codelineno-26-31" name="__codelineno-26-31"></a>
<a id="__codelineno-26-32" name="__codelineno-26-32"></a><span class="c1"># Creating the UI</span>
<a id="__codelineno-26-33" name="__codelineno-26-33"></a><span class="k">with</span> <span class="n">gr</span><span class="o">.</span><span class="n">Blocks</span><span class="p">(</span><span class="n">theme</span><span class="o">=</span><span class="n">gr</span><span class="o">.</span><span class="n">themes</span><span class="o">.</span><span class="n">Soft</span><span class="p">())</span> <span class="k">as</span> <span class="n">demo</span><span class="p">:</span>
<a id="__codelineno-26-34" name="__codelineno-26-34"></a>    <span class="c1"># Header</span>
<a id="__codelineno-26-35" name="__codelineno-26-35"></a>    <span class="n">gr</span><span class="o">.</span><span class="n">Markdown</span><span class="p">(</span><span class="s1">&#39;&lt;center&gt;&lt;h1&gt;Food Geek&lt;/h1&gt;&lt;/center&gt;&#39;</span><span class="p">)</span>
<a id="__codelineno-26-36" name="__codelineno-26-36"></a>
<a id="__codelineno-26-37" name="__codelineno-26-37"></a>    <span class="c1"># Body</span>
<a id="__codelineno-26-38" name="__codelineno-26-38"></a>    <span class="k">with</span> <span class="n">gr</span><span class="o">.</span><span class="n">Row</span><span class="p">():</span>
<a id="__codelineno-26-39" name="__codelineno-26-39"></a>        <span class="c1"># Image uploading</span>
<a id="__codelineno-26-40" name="__codelineno-26-40"></a>        <span class="k">with</span> <span class="n">gr</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">min_width</span><span class="o">=</span><span class="mi">768</span><span class="p">):</span>
<a id="__codelineno-26-41" name="__codelineno-26-41"></a>            <span class="k">with</span> <span class="n">gr</span><span class="o">.</span><span class="n">Box</span><span class="p">():</span>
<a id="__codelineno-26-42" name="__codelineno-26-42"></a>                <span class="k">with</span> <span class="n">gr</span><span class="o">.</span><span class="n">Column</span><span class="p">():</span>
<a id="__codelineno-26-43" name="__codelineno-26-43"></a>                    <span class="nb">input</span> <span class="o">=</span> <span class="n">gr</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;numpy&#39;</span><span class="p">,</span> 
<a id="__codelineno-26-44" name="__codelineno-26-44"></a>                                     <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Image&#39;</span><span class="p">)</span>
<a id="__codelineno-26-45" name="__codelineno-26-45"></a>                    <span class="k">with</span> <span class="n">gr</span><span class="o">.</span><span class="n">Row</span><span class="p">():</span>
<a id="__codelineno-26-46" name="__codelineno-26-46"></a>                        <span class="n">btn_clear</span> <span class="o">=</span> <span class="n">gr</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s1">&#39;Clear&#39;</span><span class="p">)</span>
<a id="__codelineno-26-47" name="__codelineno-26-47"></a>                        <span class="n">btn_submit</span> <span class="o">=</span> <span class="n">gr</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s2">&quot;Submit&quot;</span><span class="p">,</span> 
<a id="__codelineno-26-48" name="__codelineno-26-48"></a>                                               <span class="n">variant</span><span class="o">=</span><span class="s1">&#39;primary&#39;</span><span class="p">)</span>
<a id="__codelineno-26-49" name="__codelineno-26-49"></a>                    <span class="n">gr</span><span class="o">.</span><span class="n">Examples</span><span class="p">(</span><span class="n">examples</span><span class="o">=</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;examples/*.jpg&#39;</span><span class="p">),</span>
<a id="__codelineno-26-50" name="__codelineno-26-50"></a>                                <span class="n">inputs</span><span class="o">=</span><span class="nb">input</span><span class="p">)</span>
<a id="__codelineno-26-51" name="__codelineno-26-51"></a>        <span class="c1"># Displaying resulted image</span>
<a id="__codelineno-26-52" name="__codelineno-26-52"></a>        <span class="n">output</span> <span class="o">=</span> <span class="n">gr</span><span class="o">.</span><span class="n">AnnotatedImage</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Result&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">style</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span> <span class="n">color_map</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">})</span>
<a id="__codelineno-26-53" name="__codelineno-26-53"></a>
<a id="__codelineno-26-54" name="__codelineno-26-54"></a>    <span class="c1"># Additional info textbox </span>
<a id="__codelineno-26-55" name="__codelineno-26-55"></a>    <span class="n">food_info_box</span> <span class="o">=</span> <span class="n">gr</span><span class="o">.</span><span class="n">Textbox</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Food Info&#39;</span><span class="p">)</span>
<a id="__codelineno-26-56" name="__codelineno-26-56"></a>
<a id="__codelineno-26-57" name="__codelineno-26-57"></a>    <span class="c1"># Footer</span>
<a id="__codelineno-26-58" name="__codelineno-26-58"></a>    <span class="n">gr</span><span class="o">.</span><span class="n">Markdown</span><span class="p">(</span><span class="s1">&#39;Made by John - [Github Link](https://github.com/JohnPPinto/food-geek-food-image-segmentation)&#39;</span><span class="p">)</span>
<a id="__codelineno-26-59" name="__codelineno-26-59"></a>
<a id="__codelineno-26-60" name="__codelineno-26-60"></a>    <span class="c1"># On selected event</span>
<a id="__codelineno-26-61" name="__codelineno-26-61"></a>    <span class="n">btn_submit</span><span class="o">.</span><span class="n">click</span><span class="p">(</span><span class="n">fn</span><span class="o">=</span><span class="n">gradio_predict</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="nb">input</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">output</span><span class="p">)</span>
<a id="__codelineno-26-62" name="__codelineno-26-62"></a>    <span class="n">btn_clear</span><span class="o">.</span><span class="n">click</span><span class="p">(</span><span class="n">fn</span><span class="o">=</span><span class="n">on_clear_btn</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="nb">input</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">food_info_box</span><span class="p">])</span>
<a id="__codelineno-26-63" name="__codelineno-26-63"></a>    <span class="n">output</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">fn</span><span class="o">=</span><span class="n">on_annot_select</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">food_info_box</span><span class="p">)</span>
<a id="__codelineno-26-64" name="__codelineno-26-64"></a>
<a id="__codelineno-26-65" name="__codelineno-26-65"></a><span class="c1"># Mounting the gradio app onto the fastAPI app</span>
<a id="__codelineno-26-66" name="__codelineno-26-66"></a><span class="n">app</span> <span class="o">=</span> <span class="n">gr</span><span class="o">.</span><span class="n">mount_gradio_app</span><span class="p">(</span><span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">,</span> <span class="n">blocks</span><span class="o">=</span><span class="n">demo</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<a id="__codelineno-26-67" name="__codelineno-26-67"></a>
<a id="__codelineno-26-68" name="__codelineno-26-68"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<a id="__codelineno-26-69" name="__codelineno-26-69"></a>    <span class="n">uvicorn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;app:app&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="c1"># loading env</span>
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="n">load_dotenv</span><span class="p">()</span>
<a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="n">API_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;API_KEY&#39;</span><span class="p">)</span>
<a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a>
<a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="c1"># Matching classes with FDC ID</span>
<a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a><span class="n">food_list_id</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;chicken curry&#39;</span><span class="p">:</span> <span class="s1">&#39;2341861&#39;</span><span class="p">,</span> 
<a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a>                <span class="s1">&#39;chocolate cake&#39;</span><span class="p">:</span> <span class="s1">&#39;2343346&#39;</span><span class="p">,</span> 
<a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a>                <span class="s1">&#39;hamburger&#39;</span><span class="p">:</span> <span class="s1">&#39;2342374&#39;</span><span class="p">,</span> 
<a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a>                <span class="s1">&#39;pizza&#39;</span><span class="p">:</span> <span class="s1">&#39;2344102&#39;</span><span class="p">,</span> 
<a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a>                <span class="s1">&#39;ramen&#39;</span><span class="p">:</span> <span class="s1">&#39;2341959&#39;</span><span class="p">}</span>
<a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a>
<a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a><span class="c1"># Function to provide info on the food</span>
<a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a><span class="k">def</span> <span class="nf">fds_food_info</span><span class="p">(</span><span class="n">food_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-27-14" name="__codelineno-27-14" href="#__codelineno-27-14"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-27-15" name="__codelineno-27-15" href="#__codelineno-27-15"></a><span class="sd">    This function helps in collecting food info from the FDC database.</span>
<a id="__codelineno-27-16" name="__codelineno-27-16" href="#__codelineno-27-16"></a><span class="sd">    Parameters:</span>
<a id="__codelineno-27-17" name="__codelineno-27-17" href="#__codelineno-27-17"></a><span class="sd">        food_name: A string containing one of the classes.</span>
<a id="__codelineno-27-18" name="__codelineno-27-18" href="#__codelineno-27-18"></a><span class="sd">    Returns: </span>
<a id="__codelineno-27-19" name="__codelineno-27-19" href="#__codelineno-27-19"></a><span class="sd">        food_info: A string containing all the nutritional info.</span>
<a id="__codelineno-27-20" name="__codelineno-27-20" href="#__codelineno-27-20"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-27-21" name="__codelineno-27-21" href="#__codelineno-27-21"></a>    <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://api.nal.usda.gov/fdc/v1/food&#39;</span>
<a id="__codelineno-27-22" name="__codelineno-27-22" href="#__codelineno-27-22"></a>    <span class="n">fdc_id</span> <span class="o">=</span> <span class="n">food_list_id</span><span class="p">[</span><span class="n">food_name</span><span class="p">]</span>
<a id="__codelineno-27-23" name="__codelineno-27-23" href="#__codelineno-27-23"></a>
<a id="__codelineno-27-24" name="__codelineno-27-24" href="#__codelineno-27-24"></a>    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">fdc_id</span><span class="p">,</span> 
<a id="__codelineno-27-25" name="__codelineno-27-25" href="#__codelineno-27-25"></a>                            <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Accept&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">},</span> 
<a id="__codelineno-27-26" name="__codelineno-27-26" href="#__codelineno-27-26"></a>                            <span class="n">auth</span><span class="o">=</span><span class="n">HTTPBasicAuth</span><span class="p">(</span><span class="n">API_KEY</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
<a id="__codelineno-27-27" name="__codelineno-27-27" href="#__codelineno-27-27"></a>
<a id="__codelineno-27-28" name="__codelineno-27-28" href="#__codelineno-27-28"></a>    <span class="n">obj</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span> <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-27-29" name="__codelineno-27-29" href="#__codelineno-27-29"></a>
<a id="__codelineno-27-30" name="__codelineno-27-30" href="#__codelineno-27-30"></a>    <span class="k">if</span> <span class="n">obj</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-27-31" name="__codelineno-27-31" href="#__codelineno-27-31"></a>        <span class="n">info_list</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-27-32" name="__codelineno-27-32" href="#__codelineno-27-32"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;foodNutrients&#39;</span><span class="p">]:</span>
<a id="__codelineno-27-33" name="__codelineno-27-33" href="#__codelineno-27-33"></a>            <span class="n">info_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;nutrient&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-27-34" name="__codelineno-27-34" href="#__codelineno-27-34"></a>
<a id="__codelineno-27-35" name="__codelineno-27-35" href="#__codelineno-27-35"></a>        <span class="n">food_info</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Food Name: </span><span class="si">{</span><span class="n">food_name</span><span class="si">}</span><span class="se">\n</span><span class="s1">Nutritional Info:</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;,</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">elem</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">info_list</span><span class="p">)])</span>
<a id="__codelineno-27-36" name="__codelineno-27-36" href="#__codelineno-27-36"></a>        <span class="k">return</span> <span class="n">food_info</span>
<a id="__codelineno-27-37" name="__codelineno-27-37" href="#__codelineno-27-37"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-27-38" name="__codelineno-27-38" href="#__codelineno-27-38"></a>        <span class="k">return</span> <span class="n">response</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;There&#39;s no information for this food.&quot;</span>
</code></pre></div>
</div>
</div>
</div>
<p>To properly deploy the application, I used Docker and HuggingFace spaces to host the web application, using Dockerfile, HuggingFace can easily host any kind of application.</p>
<p>Below are the images of the Fast API app and Gradio Web app</p>
<figure>
<p><a class="glightbox" href="images/fastapi_app.png" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="FastAPI app" src="images/fastapi_app.png" /></a>
  </p>
<figcaption>Food Geek - FastAPI (<a href="https://johnpinto-food-geek.hf.space/docs" target="_blank">Link</a>)</figcaption>
</figure>
<figure>
<p><a class="glightbox" href="images/gradio_web_app.png" data-type="image" data-width="100%" data-height="auto" data-desc-position="bottom"><img alt="Gradio web app" src="images/gradio_web_app.png" /></a>
  </p>
<figcaption>Food Geek - Web Application (<a href="https://johnpinto-food-geek.hf.space" target="_blank">Link</a>)</figcaption>
</figure>
<h2 id="future-prospect"><strong>Future Prospect</strong></h2>
<p>There are many things that need to be done now that the first stage of deployment is been completed. Some of them are:</p>
<ol>
<li>
<p><strong>Data Pipeline:</strong> Currently, I'm using the public dataset Food-101, which was introduced back in the year 2014, a lot of time has passed and so has the food data, data needs to be fresh and this can be achieved by scraping the data from online websites. </p>
</li>
<li>
<p><strong>Model Pipeline:</strong> I have not yet used the full potential of the Yolo Model, using all the features and squeezing the model to get the right and balanced mAP for all the classes that need to be achieved.</p>
</li>
<li>
<p><strong>Deployment Pipeline:</strong> Right now the model is running on HuggingFace which makes it difficult to interact with once it is been hosted. This can be improved by looking into cloud deployment.</p>
</li>
<li>
<p><strong>Monitoring Pipeline:</strong> This is not something different it mostly goes hand-in-hand with the deployment pipeline, right now I don't know how the model is performing after the deployment, or even how the resources are been allocated to the web application, how long does it take for the model to give out predictions and how long does the whole process takes for the output to be seen by the user (lack of latency data)</p>
</li>
<li>
<p><strong>Automation Pipeline:</strong> This is a level 2 MLOps feature, here most of the features will be automated, something that I'm interested in learning and implementing. This will help in also getting our model to train by the inputs it received, like a self-learning continuous training feature.</p>
</li>
</ol>
<h2 id="final-words"><strong>Final Words</strong></h2>
<p>I'm quite satisfied with how it has turned out, it's not the perfect version of what I'm imagining but it is close and it's just the start of the project. The code is working, and the structure and workflow are cleanly implemented, this as a base now has quite potential for improvement. Now the project will need less coding for some time and more emphasis on the data and model improvement. One day, I hope that the model can work on multiple different classes or foods and thus fully close the feedback loop of continuous improvement.</p>
<p><em>Do test the <a href="https://johnpinto-food-geek.hf.space">Food Geek</a> application and let me know your feedback. You can reach out to me by any means possible GitHub, Twitter, Email, etc.</em> </p>
<p><em>If you find any issues in the code or have something to discuss you can raise an issue on the <a href="https://github.com/JohnPPinto/food-geek-food-image-segmentation/issues">GitHub website</a>.</em></p>





                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      &copy; 2023 <a href="https://github.com/JohnPPinto"  target="_blank" rel="noopener">John Pinto</a>
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/JohnPPinto" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://hub.docker.com/u/johnppinto" target="_blank" rel="noopener" title="hub.docker.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M349.9 236.3h-66.1v-59.4h66.1v59.4zm0-204.3h-66.1v60.7h66.1V32zm78.2 144.8H362v59.4h66.1v-59.4zm-156.3-72.1h-66.1v60.1h66.1v-60.1zm78.1 0h-66.1v60.1h66.1v-60.1zm276.8 100c-14.4-9.7-47.6-13.2-73.1-8.4-3.3-24-16.7-44.9-41.1-63.7l-14-9.3-9.3 14c-18.4 27.8-23.4 73.6-3.7 103.8-8.7 4.7-25.8 11.1-48.4 10.7H2.4c-8.7 50.8 5.8 116.8 44 162.1 37.1 43.9 92.7 66.2 165.4 66.2 157.4 0 273.9-72.5 328.4-204.2 21.4.4 67.6.1 91.3-45.2 1.5-2.5 6.6-13.2 8.5-17.1l-13.3-8.9zm-511.1-27.9h-66v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm-78.1-72.1h-66.1v60.1h66.1v-60.1z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://twitter.com/john77272002" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://www.linkedin.com/in/john-p-pinto/" target="_blank" rel="noopener" title="www.linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": ".", "features": ["navigation.tracking", "toc.integrate", "toc.follow", "navigation.top", "search.suggest", "search.highlight", "content.tabs.link", "content.code.annotation", "content.code.copy"], "search": "assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="assets/javascripts/bundle.aecac24b.min.js"></script>
      
    
  <script>document$.subscribe(() => {const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});})</script></body>
</html>